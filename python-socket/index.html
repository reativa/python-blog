<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.1d07f1255d05a1395a48.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.18.12"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2374911412821725'); // Insert your pixel ID here.
  fbq('track', 'PageView');
      </script><script>window.dataLayer = window.dataLayer || [];window.dataLayer.push({"platform":"plataforma-reativa"}); (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl+'';f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer', 'GTM-KZH8KWD');</script><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a4533d42454f73956ac7c2f680393b78"/><title data-react-helmet="true">Python tudo sobre Sockets | Python para impacientes</title><meta data-react-helmet="true" name="description" content="Socket programming is inevitable for most programmers even though Python
provides much high-level networking interface such as httplib, urllib,
imaplib…"/><meta data-react-helmet="true" property="og:title" content="Python tudo sobre Sockets"/><meta data-react-helmet="true" property="og:description" content="Socket programming is inevitable for most programmers even though Python
provides much high-level networking interface such as httplib, urllib,
imaplib…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Reativa"/><meta data-react-helmet="true" name="twitter:title" content="Python tudo sobre Sockets"/><meta data-react-helmet="true" name="twitter:description" content="Socket programming is inevitable for most programmers even though Python
provides much high-level networking interface such as httplib, urllib,
imaplib…"/><link as="script" rel="preload" href="/webpack-runtime-002569f02672c1c38772.js"/><link as="script" rel="preload" href="/styles-989bb08664f2608f37ec.js"/><link as="script" rel="preload" href="/netlify-identity-widget-71f3202b04975b5e224a.js"/><link as="script" rel="preload" href="/app-da4c9f678cc075cd8c26.js"/><link as="script" rel="preload" href="/commons-2011af21236d35f89581.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-2642abeb110b544c12ef.js"/><link as="fetch" rel="preload" href="/page-data/python-socket/page-data.json" crossorigin="anonymous"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KZH8KWD" height="0" width="0" style="display: none; visibility: hidden"></iframe></noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/">Python para impacientes</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">Python tudo sobre Sockets</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">January 05, 2020</p></header><section><h1></h1>
<p>Socket programming is inevitable for most programmers even though Python
provides much high-level networking interface such as httplib, urllib,
imaplib, telnetlib and so on. Some Unix-Like system’s interfaces were
called through socket interface, e.g., Netlink, Kernel cryptography. To
temper a pain to read long-winded documents or source code, this cheat
sheet tries to collect some common or uncommon snippets which are
related to low-level socket programming.</p>
<h2>Get Hostname</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> socket
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token string">'MacBookPro-4380.local'</span>
<span class="token operator">>></span><span class="token operator">></span> hostname <span class="token operator">=</span> socket<span class="token punctuation">.</span>gethostname<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span>hostname<span class="token punctuation">)</span>
<span class="token string">'172.20.10.4'</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>gethostbyname<span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">)</span>
<span class="token string">'127.0.0.1'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Get address family and socket address from string</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> sys


<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> res <span class="token keyword">in</span> socket<span class="token punctuation">.</span>getaddrinfo<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                                  proto<span class="token operator">=</span>socket<span class="token punctuation">.</span>IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">:</span>
        family <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        sockaddr <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> sockaddr<span class="token punctuation">)</span>
<span class="token keyword">except</span> socket<span class="token punctuation">.</span>gaierror<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Invalid"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ gai.py 192.0.2.244
AddressFamily.AF_INET (&#39;192.0.2.244&#39;, 0)
$ gai.py 2001:db8:f00d::1:d
AddressFamily.AF_INET6 (&#39;2001:db8:f00d::1:d&#39;, 0, 0, 0)
$ gai.py www.google.com
AddressFamily.AF_INET6 (&#39;2607:f8b0:4006:818::2004&#39;, 0, 0, 0)
AddressFamily.AF_INET (&#39;172.217.10.132&#39;, 0)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>It handles unusual cases, valid and invalid:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ gai.py 10.0.0.256  # octet overflow
Invalid
$ gai.py not-exist.example.com  # unresolvable
Invalid
$ gai.py fe80::1%eth0  # scoped
AddressFamily.AF_INET6 (&#39;fe80::1%eth0&#39;, 0, 0, 2)
$ gai.py ::ffff:192.0.2.128  # IPv4-Mapped
AddressFamily.AF_INET6 (&#39;::ffff:192.0.2.128&#39;, 0, 0, 0)
$ gai.py 0xc000027b  # IPv4 in hex
AddressFamily.AF_INET (&#39;192.0.2.123&#39;, 0)
$ gai.py 3221226198  # IPv4 in decimal
AddressFamily.AF_INET (&#39;192.0.2.214&#39;, 0)</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Transform Host &#x26; Network Endian</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># little-endian machine</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> socket
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># host endian</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>htons<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment"># network endian</span>
<span class="token number">256</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>htonl<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment"># network endian</span>
<span class="token number">16777216</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>ntohs<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token comment"># host endian</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>ntohl<span class="token punctuation">(</span><span class="token number">16777216</span><span class="token punctuation">)</span> <span class="token comment"># host endian</span>
<span class="token number">1</span>

<span class="token comment"># big-endian machine</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> socket
<span class="token operator">>></span><span class="token operator">></span> a <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment"># host endian</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>htons<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment"># network endian</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>htonl<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment"># network endian</span>
1L
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>ntohs<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># host endian</span>
<span class="token number">1</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>ntohl<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># host endian</span>
1L</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>IP dotted-quad string &#x26; byte format convert</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> socket
<span class="token operator">>></span><span class="token operator">></span> addr <span class="token operator">=</span> socket<span class="token punctuation">.</span>inet_aton<span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> addr
<span class="token string">'\x7f\x00\x00\x01'</span>
<span class="token operator">>></span><span class="token operator">></span> socket<span class="token punctuation">.</span>inet_ntoa<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
<span class="token string">'127.0.0.1'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Mac address &#x26; byte format convert</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> binascii
<span class="token operator">>></span><span class="token operator">></span> mac <span class="token operator">=</span> <span class="token string">'00:11:32:3c:c3:0b'</span>
<span class="token operator">>></span><span class="token operator">></span> byte <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>mac<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> byte
<span class="token string">'\x00\x112&lt;\xc3\x0b'</span>
<span class="token operator">>></span><span class="token operator">></span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>byte<span class="token punctuation">)</span>
<span class="token string">'0011323cc30b'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple TCP Echo Server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket

<span class="token keyword">class</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>_port <span class="token operator">=</span> port
    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_sock <span class="token operator">=</span> sock
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_sock
    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>exc_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> exc_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> traceback
            traceback<span class="token punctuation">.</span>print_exception<span class="token punctuation">(</span><span class="token operator">*</span>exc_info<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    host <span class="token operator">=</span> <span class="token string">'localhost'</span>
    port <span class="token operator">=</span> <span class="token number">5566</span>
    <span class="token keyword">with</span> Server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello World
Hello World</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple TCP Echo Server through IPv6</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> socket

host <span class="token operator">=</span> <span class="token string">"::1"</span>
port <span class="token operator">=</span> <span class="token number">5566</span>


@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET6<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">with</span> server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
                conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

            conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 ipv6.py <span class="token operator">&amp;</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">25752</span>
$ <span class="token function">nc</span> -6 ::1 <span class="token number">5566</span>
Hello IPv6
Hello IPv6</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Disable IPv6 Only</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span>

<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> socket

host <span class="token operator">=</span> <span class="token string">"::"</span>
port <span class="token operator">=</span> <span class="token number">5566</span>

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span>host<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET6<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>IPPROTO_IPV6<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>IPV6_V6ONLY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">with</span> server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
            remote <span class="token operator">=</span> conn<span class="token punctuation">.</span>getpeername<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>remote<span class="token punctuation">)</span>
            msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
                conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

            conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 ipv6.py <span class="token operator">&amp;</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token number">23914</span>
$ <span class="token function">nc</span> -4 <span class="token number">127.0</span>.0.1 <span class="token number">5566</span>
<span class="token punctuation">(</span><span class="token string">'::ffff:127.0.0.1'</span>, <span class="token number">42604</span>, <span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>
Hello IPv4
Hello IPv4
$ <span class="token function">nc</span> -6 ::1 <span class="token number">5566</span>
<span class="token punctuation">(</span><span class="token string">'::1'</span>, <span class="token number">50882</span>, <span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>
Hello IPv6
Hello IPv6
$ <span class="token function">nc</span> -6 fe80::a00:27ff:fe9b:50ee%enp0s3 <span class="token number">5566</span>
<span class="token punctuation">(</span><span class="token string">'fe80::a00:27ff:fe9b:50ee%enp0s3'</span>, <span class="token number">42042</span>, <span class="token number">0</span>, <span class="token number">2</span><span class="token punctuation">)</span>
Hello IPv6
Hello IPv6</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple TCP Echo Server Via SocketServer</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> SocketServer
<span class="token operator">>></span><span class="token operator">></span> bh <span class="token operator">=</span> SocketServer<span class="token punctuation">.</span>BaseRequestHandler
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">handler</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_address<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> host <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> SocketServer<span class="token punctuation">.</span>TCPServer<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   host<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello World
Hello World</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple TLS/SSL TCP Echo Server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> ssl

sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

sslctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLSv1<span class="token punctuation">)</span>
sslctx<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span>certfile<span class="token operator">=</span><span class="token string">'./root-ca.crt'</span><span class="token punctuation">,</span>
                       keyfile<span class="token operator">=</span><span class="token string">'./root-ca.key'</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sslconn <span class="token operator">=</span> sslctx<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> server_side<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> sslconn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
            sslconn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        sslconn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># console 1</span>
$ openssl genrsa -out root-ca.key <span class="token number">2048</span>
$ openssl req -x509 -new -nodes -key root-ca.key -days <span class="token number">365</span> -out root-ca.crt
$ python3 ssl_tcp_server.py

<span class="token comment"># console 2</span>
$ openssl s_client -connect localhost:5566
<span class="token punctuation">..</span>.
Hello SSL
Hello SSL
read:errno<span class="token operator">=</span><span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Set ciphers on TLS/SSL TCP Echo Server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> json
<span class="token keyword">import</span> ssl

sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

sslctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_SSLv23<span class="token punctuation">)</span>
sslctx<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span>certfile<span class="token operator">=</span><span class="token string">'cert.pem'</span><span class="token punctuation">,</span>
                       keyfile<span class="token operator">=</span><span class="token string">'key.pem'</span><span class="token punctuation">)</span>
<span class="token comment"># set ssl ciphers</span>
sslctx<span class="token punctuation">.</span>set_ciphers<span class="token punctuation">(</span><span class="token string">'ECDH-ECDSA-AES128-GCM-SHA256'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>sslctx<span class="token punctuation">.</span>get_ciphers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        sslconn <span class="token operator">=</span> sslctx<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> server_side<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> sslconn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
            sslconn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        sslconn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ openssl ecparam -out key.pem -genkey -name prime256v1
$ openssl req -x509 -new -key key.pem -out cert.pem
$ python3 tls.py<span class="token operator">&amp;</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token number">64565</span>
<span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token number">50380845</span>,
    <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"ECDH-ECDSA-AES128-GCM-SHA256"</span>,
    <span class="token string">"protocol"</span><span class="token builtin class-name">:</span> <span class="token string">"TLSv1/SSLv3"</span>,
    <span class="token string">"description"</span><span class="token builtin class-name">:</span> <span class="token string">"ECDH-ECDSA-AES128-GCM-SHA256 TLSv1.2 Kx=ECDH/ECDSA Au=ECDH Enc=AESGCM(128) Mac=AEAD"</span>,
    <span class="token string">"strength_bits"</span><span class="token builtin class-name">:</span> <span class="token number">128</span>,
    <span class="token string">"alg_bits"</span><span class="token builtin class-name">:</span> <span class="token number">128</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
$ openssl s_client -connect localhost:5566 -cipher <span class="token string">"ECDH-ECDSA-AES128-GCM-SHA256"</span>
<span class="token punctuation">..</span>.
---
Hello ECDH-ECDSA-AES128-GCM-SHA256
Hello ECDH-ECDSA-AES128-GCM-SHA256
read:errno<span class="token operator">=</span><span class="token number">0</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple UDP Echo Server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket

<span class="token keyword">class</span> <span class="token class-name">UDPServer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>_port <span class="token operator">=</span> port

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>
        sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_sock <span class="token operator">=</span> sock
        <span class="token keyword">return</span> sock
   <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>exc_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> exc_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">import</span> traceback
            traceback<span class="token punctuation">.</span>print_exception<span class="token punctuation">(</span><span class="token operator">*</span>exc_info<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    host <span class="token operator">=</span> <span class="token string">'localhost'</span>
    port <span class="token operator">=</span> <span class="token number">5566</span>
    <span class="token keyword">with</span> UDPServer<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            msg<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
            s<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>msg<span class="token punctuation">,</span> addr<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc -u localhost 5566
Hello World
Hello World</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple UDP Echo Server Via SocketServer</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> SocketServer
<span class="token operator">>></span><span class="token operator">></span> bh <span class="token operator">=</span> SocketServer<span class="token punctuation">.</span>BaseRequestHandler
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">handler</span><span class="token punctuation">(</span>bh<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     m<span class="token punctuation">,</span>s <span class="token operator">=</span> self<span class="token punctuation">.</span>request
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     s<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>m<span class="token punctuation">,</span>self<span class="token punctuation">.</span>client_address<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_address<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> host <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s <span class="token operator">=</span> SocketServer<span class="token punctuation">.</span>UDPServer<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   host<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> s<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc -u localhost 5566
Hello World
Hello World</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple UDP client - Sender</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> socket
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> time
<span class="token operator">>></span><span class="token operator">></span> sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> host <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span><span class="token string">"Hello\n"</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc -lu localhost 5566
Hello
Hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Broadcast UDP Packets</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> socket
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> time
<span class="token operator">>></span><span class="token operator">></span> sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_BROADCAST<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   m <span class="token operator">=</span> <span class="token string">'{0}\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>m<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'&lt;broadcast>'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc -k -w 1 -ul 5566
1431473025.72</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<h2>Simple UNIX Domain Socket</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> os

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">DomainServer</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
        sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_UNIX<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
        sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> sock
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>

addr <span class="token operator">=</span> <span class="token string">"./domain.sock"</span>
<span class="token keyword">with</span> DomainServer<span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token keyword">as</span> sock<span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> _ <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc -U ./domain.sock
Hello
Hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple duplex processes communication</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> socket

child<span class="token punctuation">,</span> parent <span class="token operator">=</span> socket<span class="token punctuation">.</span>socketpair<span class="token punctuation">(</span><span class="token punctuation">)</span>
pid <span class="token operator">=</span> os<span class="token punctuation">.</span>fork<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>

    <span class="token keyword">if</span> pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'chlid pid: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        child<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'Hello Parent'</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> child<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'p[{}] ---> c[{}]: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
            os<span class="token punctuation">.</span>getppid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'parent pid: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># simple echo server (parent)</span>
        msg <span class="token operator">=</span> parent<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'c[{}] ---> p[{}]: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                pid<span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        parent<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    child<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    parent<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 socketpair_demo.py
parent pid: <span class="token number">9497</span>
chlid pid: <span class="token number">9498</span>
c<span class="token punctuation">[</span><span class="token number">9498</span><span class="token punctuation">]</span> ---<span class="token operator">></span> p<span class="token punctuation">[</span><span class="token number">9497</span><span class="token punctuation">]</span>: b<span class="token string">'Hello Parent'</span>
p<span class="token punctuation">[</span><span class="token number">9497</span><span class="token punctuation">]</span> ---<span class="token operator">></span> c<span class="token punctuation">[</span><span class="token number">9498</span><span class="token punctuation">]</span>: b<span class="token string">'Hello Parent'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple Asynchronous TCP Server - Thread</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> socket
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">work</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   conn<span class="token punctuation">,</span>addr <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   t<span class="token operator">=</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>work<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   t<span class="token punctuation">.</span>daemon<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello
Hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 2)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Ker Ker
Ker Ker</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple Asynchronous TCP Server - select</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">from</span> select <span class="token keyword">import</span> select
<span class="token keyword">import</span> socket

host <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span>
sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>host<span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
rl <span class="token operator">=</span> <span class="token punctuation">[</span>sock<span class="token punctuation">]</span>
wl <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
ml <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        r<span class="token punctuation">,</span> w<span class="token punctuation">,</span> _ <span class="token operator">=</span> select<span class="token punctuation">(</span>rl<span class="token punctuation">,</span> wl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># process ready to ready</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> r<span class="token punctuation">:</span>
            <span class="token keyword">if</span> _ <span class="token operator">==</span> sock<span class="token punctuation">:</span>
                conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
                rl<span class="token punctuation">.</span>append<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                msg <span class="token operator">=</span> _<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
                ml<span class="token punctuation">[</span>_<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> msg
                wl<span class="token punctuation">.</span>append<span class="token punctuation">(</span>_<span class="token punctuation">)</span>
        <span class="token comment"># process ready to write</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> w<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> ml<span class="token punctuation">[</span>_<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            _<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
            wl<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>_<span class="token punctuation">)</span>
            <span class="token keyword">del</span> ml<span class="token punctuation">[</span>_<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello
Hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 2)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Ker Ker
Ker Ker</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple Asynchronous TCP Server - poll</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function<span class="token punctuation">,</span> unicode_literals

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> select
<span class="token keyword">import</span> contextlib

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">5566</span>

con <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
req <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
resp <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Get socket error"</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> s<span class="token punctuation">:</span> s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        e <span class="token operator">=</span> select<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> e
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> fd<span class="token punctuation">,</span> c <span class="token keyword">in</span> con<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            e<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">accept</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> poll<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    fd <span class="token operator">=</span> conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    poll<span class="token punctuation">.</span>register<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> select<span class="token punctuation">.</span>POLLIN<span class="token punctuation">)</span>
    req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
    con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn


<span class="token keyword">def</span> <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> poll<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fd <span class="token keyword">not</span> <span class="token keyword">in</span> req<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    conn <span class="token operator">=</span> req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
        resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> msg
        poll<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> select<span class="token punctuation">.</span>POLLOUT<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">del</span> con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>

    <span class="token keyword">del</span> req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> poll<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fd <span class="token keyword">not</span> <span class="token keyword">in</span> resp<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    conn <span class="token operator">=</span> con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    msg <span class="token operator">=</span> resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    b <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">while</span> total <span class="token operator">></span> b<span class="token punctuation">:</span>
        l <span class="token operator">=</span> conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        msg <span class="token operator">=</span> msg<span class="token punctuation">[</span>l<span class="token punctuation">:</span><span class="token punctuation">]</span>
        b <span class="token operator">+=</span> l

    <span class="token keyword">del</span> resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
    poll<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> select<span class="token punctuation">.</span>POLLIN<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> server<span class="token punctuation">,</span> Poll<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> poll<span class="token punctuation">:</span>

        poll<span class="token punctuation">.</span>register<span class="token punctuation">(</span>server<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            events <span class="token operator">=</span> poll<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> fd<span class="token punctuation">,</span> e <span class="token keyword">in</span> events<span class="token punctuation">:</span>
                <span class="token keyword">if</span> fd <span class="token operator">==</span> server<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    accept<span class="token punctuation">(</span>server<span class="token punctuation">,</span> poll<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e <span class="token operator">&amp;</span> <span class="token punctuation">(</span>select<span class="token punctuation">.</span>POLLIN <span class="token operator">|</span> select<span class="token punctuation">.</span>POLLPRI<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    recv<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> poll<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e <span class="token operator">&amp;</span> select<span class="token punctuation">.</span>POLLOUT<span class="token punctuation">:</span>
                    send<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> poll<span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 poll.py &amp;
[1] 3036
$ nc localhost 5566
Hello poll
Hello poll
Hello Python Socket Programming
Hello Python Socket Programming</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 2)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello Python
Hello Python
Hello Awesome Python
Hello Awesome Python</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple Asynchronous TCP Server - epoll</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function<span class="token punctuation">,</span> unicode_literals

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> select
<span class="token keyword">import</span> contextlib


host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">5566</span>

con <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
req <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
resp <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Get socket error"</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> s<span class="token punctuation">:</span> s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Epoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        e <span class="token operator">=</span> select<span class="token punctuation">.</span>epoll<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> e
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> fd <span class="token keyword">in</span> con<span class="token punctuation">:</span> e<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
        e<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">accept</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> epoll<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    fd <span class="token operator">=</span> conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    epoll<span class="token punctuation">.</span>register<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> select<span class="token punctuation">.</span>EPOLLIN<span class="token punctuation">)</span>
    req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
    con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn


<span class="token keyword">def</span> <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> epoll<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fd <span class="token keyword">not</span> <span class="token keyword">in</span> req<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    conn <span class="token operator">=</span> req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
        resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> msg
        epoll<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> select<span class="token punctuation">.</span>EPOLLOUT<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">del</span> con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>

    <span class="token keyword">del</span> req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> epoll<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fd <span class="token keyword">not</span> <span class="token keyword">in</span> resp<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    conn <span class="token operator">=</span> con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    msg <span class="token operator">=</span> resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    b <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">while</span> total <span class="token operator">></span> b<span class="token punctuation">:</span>
        l <span class="token operator">=</span> conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        msg <span class="token operator">=</span> msg<span class="token punctuation">[</span>l<span class="token punctuation">:</span><span class="token punctuation">]</span>
        b <span class="token operator">+=</span> l

    <span class="token keyword">del</span> resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
    epoll<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> select<span class="token punctuation">.</span>EPOLLIN<span class="token punctuation">)</span>


<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> server<span class="token punctuation">,</span> Epoll<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> epoll<span class="token punctuation">:</span>

        epoll<span class="token punctuation">.</span>register<span class="token punctuation">(</span>server<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            events <span class="token operator">=</span> epoll<span class="token punctuation">.</span>poll<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> fd<span class="token punctuation">,</span> e <span class="token keyword">in</span> events<span class="token punctuation">:</span>
                <span class="token keyword">if</span> fd <span class="token operator">==</span> server<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    accept<span class="token punctuation">(</span>server<span class="token punctuation">,</span> epoll<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e <span class="token operator">&amp;</span> select<span class="token punctuation">.</span>EPOLLIN<span class="token punctuation">:</span>
                    recv<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> epoll<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e <span class="token operator">&amp;</span> select<span class="token punctuation">.</span>EPOLLOUT<span class="token punctuation">:</span>
                    send<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> epoll<span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 epoll.py &amp;
[1] 3036
$ nc localhost 5566
Hello epoll
Hello epoll
Hello Python Socket Programming
Hello Python Socket Programming</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 2)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello Python
Hello Python
Hello Awesome Python
Hello Awesome Python</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple Asynchronous TCP Server - kqueue</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function<span class="token punctuation">,</span> unicode_literals

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> select
<span class="token keyword">import</span> contextlib

<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>select<span class="token punctuation">,</span> <span class="token string">'kqueue'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Not support kqueue"</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>


host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">5566</span>

con <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
req <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
resp <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Get socket error"</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> s<span class="token punctuation">:</span> s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Kqueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        kq <span class="token operator">=</span> select<span class="token punctuation">.</span>kqueue<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> kq
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        kq<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> fd<span class="token punctuation">,</span> c <span class="token keyword">in</span> con<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">accept</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> kq<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    fd <span class="token operator">=</span> conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    ke <span class="token operator">=</span> select<span class="token punctuation">.</span>kevent<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       select<span class="token punctuation">.</span>KQ_FILTER_READ<span class="token punctuation">,</span>
                       select<span class="token punctuation">.</span>KQ_EV_ADD<span class="token punctuation">)</span>
    kq<span class="token punctuation">.</span>control<span class="token punctuation">(</span><span class="token punctuation">[</span>ke<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
    con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn


<span class="token keyword">def</span> <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> kq<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fd <span class="token keyword">not</span> <span class="token keyword">in</span> req<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    conn <span class="token operator">=</span> req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
        resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> msg
        <span class="token comment"># remove read event</span>
        ke <span class="token operator">=</span> select<span class="token punctuation">.</span>kevent<span class="token punctuation">(</span>fd<span class="token punctuation">,</span>
                           select<span class="token punctuation">.</span>KQ_FILTER_READ<span class="token punctuation">,</span>
                           select<span class="token punctuation">.</span>KQ_EV_DELETE<span class="token punctuation">)</span>
        kq<span class="token punctuation">.</span>control<span class="token punctuation">(</span><span class="token punctuation">[</span>ke<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># add write event</span>
        ke <span class="token operator">=</span> select<span class="token punctuation">.</span>kevent<span class="token punctuation">(</span>fd<span class="token punctuation">,</span>
                           select<span class="token punctuation">.</span>KQ_FILTER_WRITE<span class="token punctuation">,</span>
                           select<span class="token punctuation">.</span>KQ_EV_ADD<span class="token punctuation">)</span>
        kq<span class="token punctuation">.</span>control<span class="token punctuation">(</span><span class="token punctuation">[</span>ke<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
        con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">del</span> con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>

    <span class="token keyword">del</span> req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>


<span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> kq<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> fd <span class="token keyword">not</span> <span class="token keyword">in</span> resp<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    conn <span class="token operator">=</span> con<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    msg <span class="token operator">=</span> resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    b <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">while</span> total <span class="token operator">></span> b<span class="token punctuation">:</span>
        l <span class="token operator">=</span> conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        msg <span class="token operator">=</span> msg<span class="token punctuation">[</span>l<span class="token punctuation">:</span><span class="token punctuation">]</span>
        b <span class="token operator">+=</span> l

    <span class="token keyword">del</span> resp<span class="token punctuation">[</span>fd<span class="token punctuation">]</span>
    req<span class="token punctuation">[</span>fd<span class="token punctuation">]</span> <span class="token operator">=</span> conn
    <span class="token comment"># remove write event</span>
    ke <span class="token operator">=</span> select<span class="token punctuation">.</span>kevent<span class="token punctuation">(</span>fd<span class="token punctuation">,</span>
                       select<span class="token punctuation">.</span>KQ_FILTER_WRITE<span class="token punctuation">,</span>
                       select<span class="token punctuation">.</span>KQ_EV_DELETE<span class="token punctuation">)</span>
    kq<span class="token punctuation">.</span>control<span class="token punctuation">(</span><span class="token punctuation">[</span>ke<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># add read event</span>
    ke <span class="token operator">=</span> select<span class="token punctuation">.</span>kevent<span class="token punctuation">(</span>fd<span class="token punctuation">,</span>
                       select<span class="token punctuation">.</span>KQ_FILTER_READ<span class="token punctuation">,</span>
                       select<span class="token punctuation">.</span>KQ_EV_ADD<span class="token punctuation">)</span>
    kq<span class="token punctuation">.</span>control<span class="token punctuation">(</span><span class="token punctuation">[</span>ke<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>


<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> server<span class="token punctuation">,</span> Kqueue<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> kq<span class="token punctuation">:</span>

        max_events <span class="token operator">=</span> <span class="token number">1024</span>
        timeout <span class="token operator">=</span> <span class="token number">1</span>

        ke <span class="token operator">=</span> select<span class="token punctuation">.</span>kevent<span class="token punctuation">(</span>server<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           select<span class="token punctuation">.</span>KQ_FILTER_READ<span class="token punctuation">,</span>
                           select<span class="token punctuation">.</span>KQ_EV_ADD<span class="token punctuation">)</span>

        kq<span class="token punctuation">.</span>control<span class="token punctuation">(</span><span class="token punctuation">[</span>ke<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            events <span class="token operator">=</span> kq<span class="token punctuation">.</span>control<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> max_events<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span>
            <span class="token keyword">for</span> e <span class="token keyword">in</span> events<span class="token punctuation">:</span>
                fd <span class="token operator">=</span> e<span class="token punctuation">.</span>ident
                <span class="token keyword">if</span> fd <span class="token operator">==</span> server<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    accept<span class="token punctuation">(</span>server<span class="token punctuation">,</span> kq<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token operator">==</span> select<span class="token punctuation">.</span>KQ_FILTER_READ<span class="token punctuation">:</span>
                    recv<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> kq<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> e<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token operator">==</span> select<span class="token punctuation">.</span>KQ_FILTER_WRITE<span class="token punctuation">:</span>
                    send<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> kq<span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 kqueue.py &amp;
[1] 3036
$ nc localhost 5566
Hello kqueue
Hello kqueue
Hello Python Socket Programming
Hello Python Socket Programming</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 2)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello Python
Hello Python
Hello Awesome Python
Hello Awesome Python</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>High-Level API - selectors</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># Pyton3.4+ only</span>
<span class="token comment"># Reference: selectors</span>
<span class="token keyword">import</span> selectors
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> contextlib

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token keyword">try</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        sel <span class="token operator">=</span> selectors<span class="token punctuation">.</span>DefaultSelector<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s<span class="token punctuation">,</span> sel
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Get socket error"</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> s<span class="token punctuation">:</span>
            s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">read_handler</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> sel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    msg <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
        conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sel<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">accept_handler</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> sel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span> _ <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sel<span class="token punctuation">.</span>register<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">,</span> read_handler<span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">5566</span>
<span class="token keyword">with</span> Server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span>sel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sel<span class="token punctuation">.</span>register<span class="token punctuation">(</span>s<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">,</span> accept_handler<span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        events <span class="token operator">=</span> sel<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> sel_key<span class="token punctuation">,</span> m <span class="token keyword">in</span> events<span class="token punctuation">:</span>
            handler <span class="token operator">=</span> sel_key<span class="token punctuation">.</span>data
            handler<span class="token punctuation">(</span>sel_key<span class="token punctuation">.</span>fileobj<span class="token punctuation">,</span> sel<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hello
Hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 5566
Hi
Hi</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Simple Non-blocking TLS/SSL socket via selectors</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> selectors
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> ssl

<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial

sslctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>create_default_context<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>Purpose<span class="token punctuation">.</span>CLIENT_AUTH<span class="token punctuation">)</span>
sslctx<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span>certfile<span class="token operator">=</span><span class="token string">"cert.pem"</span><span class="token punctuation">,</span> keyfile<span class="token operator">=</span><span class="token string">"key.pem"</span><span class="token punctuation">)</span>

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">Server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        sel <span class="token operator">=</span> selectors<span class="token punctuation">.</span>DefaultSelector<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s<span class="token punctuation">,</span> sel
    <span class="token keyword">except</span> socket<span class="token punctuation">.</span>error<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Get socket error"</span><span class="token punctuation">)</span>
        <span class="token keyword">raise</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> s<span class="token punctuation">:</span> s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> sel<span class="token punctuation">:</span> sel<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">accept</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> sel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn<span class="token punctuation">,</span> _ <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sslconn <span class="token operator">=</span> sslctx<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>conn<span class="token punctuation">,</span>
                                 server_side<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                 do_handshake_on_connect<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    sel<span class="token punctuation">.</span>register<span class="token punctuation">(</span>sslconn<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">,</span> do_handshake<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">do_handshake</span><span class="token punctuation">(</span>sslconn<span class="token punctuation">,</span> sel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sslconn<span class="token punctuation">.</span>do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sel<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>sslconn<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">,</span> read<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>sslconn<span class="token punctuation">,</span> sel<span class="token punctuation">)</span><span class="token punctuation">:</span>
    msg <span class="token operator">=</span> sslconn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
        sel<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>sslconn<span class="token punctuation">,</span>
                   selectors<span class="token punctuation">.</span>EVENT_WRITE<span class="token punctuation">,</span>
                   partial<span class="token punctuation">(</span>write<span class="token punctuation">,</span> msg<span class="token operator">=</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        sel<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>sslconn<span class="token punctuation">)</span>
        sslconn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>sslconn<span class="token punctuation">,</span> sel<span class="token punctuation">,</span> msg<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> msg<span class="token punctuation">:</span>
        sslconn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    sel<span class="token punctuation">.</span>modify<span class="token punctuation">(</span>sslconn<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">,</span> read<span class="token punctuation">)</span>


host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">5566</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> Server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span>sel<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sel<span class="token punctuation">.</span>register<span class="token punctuation">(</span>s<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">,</span> accept<span class="token punctuation">)</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            events <span class="token operator">=</span> sel<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> sel_key<span class="token punctuation">,</span> m <span class="token keyword">in</span> events<span class="token punctuation">:</span>
                handler <span class="token operator">=</span> sel_key<span class="token punctuation">.</span>data
                handler<span class="token punctuation">(</span>sel_key<span class="token punctuation">.</span>fileobj<span class="token punctuation">,</span> sel<span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text"># console 1
$ openssl genrsa -out key.pem 2048
$ openssl req -x509 -new -nodes -key key.pem -days 365 -out cert.pem
$ python3 ssl_tcp_server.py &amp;
$ openssl s_client -connect localhost:5566
...
---
Hello TLS
Hello TLS

# console 2
$ openssl s_client -connect localhost:5566
...
---
Hello SSL
Hello SSL</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>“socketpair” - Similar to PIPE</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> socket
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time

c_s<span class="token punctuation">,</span> p_s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socketpair<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    pid <span class="token operator">=</span> os<span class="token punctuation">.</span>fork<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> OSError<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Fork Error"</span><span class="token punctuation">)</span>
    <span class="token keyword">raise</span>

<span class="token keyword">if</span> pid<span class="token punctuation">:</span>
    <span class="token comment"># parent process</span>
    c_s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        p_s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Hi! Child!"</span><span class="token punctuation">)</span>
        msg <span class="token operator">=</span> p_s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    os<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># child process</span>
    p_s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> c_s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        c_s<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span><span class="token string">"Hi! Parent!"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python ex.py
Hi! Child!
Hi! Parent!
Hi! Child!
Hi! Parent!
...</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Using sendfile do copy</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># need python 3.3 or above</span>
<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function<span class="token punctuation">,</span> unicode_literals

<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys

<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Usage: cmd src dst"</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

src <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
dst <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> d<span class="token punctuation">:</span>
    st <span class="token operator">=</span> os<span class="token punctuation">.</span>fstat<span class="token punctuation">(</span>s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    offset <span class="token operator">=</span> <span class="token number">0</span>
    count <span class="token operator">=</span> <span class="token number">4096</span>
    s_len <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size

    sfd <span class="token operator">=</span> s<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    dfd <span class="token operator">=</span> d<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">while</span> s_len <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> os<span class="token punctuation">.</span>sendfile<span class="token punctuation">(</span>dfd<span class="token punctuation">,</span> sfd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
        offset <span class="token operator">+=</span> ret
        s_len <span class="token operator">-=</span> ret</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ dd if=/dev/urandom of=dd.in bs=1M count=1024
1024+0 records in
1024+0 records out
1073741824 bytes (1.1 GB, 1.0 GiB) copied, 108.02 s, 9.9 MB/s
$ python3 sendfile.py dd.in dd.out
$ md5sum dd.in
e79afdd6aba71b7174142c0bbc289674  dd.in
$ md5sum dd.out
e79afdd6aba71b7174142c0bbc289674  dd.out</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Sending a file through sendfile</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># need python 3.5 or above</span>
<span class="token keyword">from</span> __future__ <span class="token keyword">import</span> print_function<span class="token punctuation">,</span> unicode_literals

<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> time
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> contextlib

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">client</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        c <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> c
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">do_sendfile</span><span class="token punctuation">(</span>fout<span class="token punctuation">,</span> fin<span class="token punctuation">,</span> count<span class="token punctuation">,</span> fin_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
    l <span class="token operator">=</span> fin_len
    offset <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> l <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> fout<span class="token punctuation">.</span>sendfile<span class="token punctuation">(</span>fin<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
        offset <span class="token operator">+=</span> ret
        l <span class="token operator">-=</span> ret


<span class="token keyword">def</span> <span class="token function">do_recv</span><span class="token punctuation">(</span>fout<span class="token punctuation">,</span> fin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> fin<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span> <span class="token keyword">break</span>

        fout<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">5566</span>

<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"usage: cmd src dst"</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

src <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
dst <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
offset <span class="token operator">=</span> <span class="token number">0</span>

pid <span class="token operator">=</span> os<span class="token punctuation">.</span>fork<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> pid <span class="token operator">==</span>  <span class="token number">0</span><span class="token punctuation">:</span>
    <span class="token comment"># client</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> client<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        fd <span class="token operator">=</span> f<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
        st <span class="token operator">=</span> os<span class="token punctuation">.</span>fstat<span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
        count <span class="token operator">=</span> <span class="token number">4096</span>

        flen <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size
        do_sendfile<span class="token punctuation">(</span>c<span class="token punctuation">,</span> f<span class="token punctuation">,</span> count<span class="token punctuation">,</span> flen<span class="token punctuation">)</span>

<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># server</span>
    <span class="token keyword">with</span> server<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">,</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        do_recv<span class="token punctuation">(</span>f<span class="token punctuation">,</span> conn<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ dd if=/dev/urandom of=dd.in bs=1M count=512
512+0 records in
512+0 records out
536870912 bytes (537 MB, 512 MiB) copied, 3.17787 s, 169 MB/s
$ python3 sendfile.py dd.in dd.out
$ md5sum dd.in
eadfd96c85976b1f46385e89dfd9c4a8  dd.in
$ md5sum dd.out
eadfd96c85976b1f46385e89dfd9c4a8  dd.out</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Linux kernel Crypto API - AF_ALG</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># need python 3.6 or above &amp; Linux >=2.6.38</span>
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> hashlib
<span class="token keyword">import</span> contextlib

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">create_alg</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_ALG<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_SEQPACKET<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

msg <span class="token operator">=</span> <span class="token string">b'Python is awesome!'</span>

<span class="token keyword">with</span> create_alg<span class="token punctuation">(</span><span class="token string">'hash'</span><span class="token punctuation">,</span> <span class="token string">'sha256'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> algo<span class="token punctuation">:</span>
    op<span class="token punctuation">,</span> _ <span class="token operator">=</span> algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">with</span> op<span class="token punctuation">:</span>
        op<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
        data <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># check data</span>
        h <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>sha256<span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> h <span class="token operator">!=</span> data<span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"sha256(</span><span class="token interpolation"><span class="token punctuation">{</span>h<span class="token punctuation">}</span></span><span class="token string">) != af_alg(</span><span class="token interpolation"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token string">)"</span></span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 af_alg.py
9d50bcac2d5e33f936ec2db7dc7b6579cba8e1b099d77c31d8564df46f66bdf5</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span></span></pre></div>
<h2>AES-CBC encrypt/decrypt via AF_ALG</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># need python 3.6 or above &amp; Linux >=4.3</span>
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> os

BS <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># Bytes</span>
pad <span class="token operator">=</span> <span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s <span class="token operator">+</span> <span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span> <span class="token operator">*</span> \
                 <span class="token builtin">chr</span><span class="token punctuation">(</span>BS <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">%</span> BS<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>

upad <span class="token operator">=</span> <span class="token keyword">lambda</span> s <span class="token punctuation">:</span> s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span>s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>


@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">create_alg</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_ALG<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_SEQPACKET<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    ciphertext <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">with</span> create_alg<span class="token punctuation">(</span><span class="token string">'skcipher'</span><span class="token punctuation">,</span> <span class="token string">'cbc(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> algo<span class="token punctuation">:</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        op<span class="token punctuation">,</span> _ <span class="token operator">=</span> algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> op<span class="token punctuation">:</span>
            plaintext <span class="token operator">=</span> pad<span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span>
            op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span><span class="token punctuation">[</span>plaintext<span class="token punctuation">]</span><span class="token punctuation">,</span>
                             op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_ENCRYPT<span class="token punctuation">,</span>
                             iv<span class="token operator">=</span>iv<span class="token punctuation">)</span>
            ciphertext <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> ciphertext


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plaintext <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">with</span> create_alg<span class="token punctuation">(</span><span class="token string">'skcipher'</span><span class="token punctuation">,</span> <span class="token string">'cbc(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> algo<span class="token punctuation">:</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        op<span class="token punctuation">,</span> _ <span class="token operator">=</span> algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> op<span class="token punctuation">:</span>
            op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span><span class="token punctuation">[</span>ciphertext<span class="token punctuation">]</span><span class="token punctuation">,</span>
                             op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_DECRYPT<span class="token punctuation">,</span>
                             iv<span class="token operator">=</span>iv<span class="token punctuation">)</span>
            plaintext <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> upad<span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span>


key <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
iv  <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

plaintext <span class="token operator">=</span> <span class="token string">b"Demo AF_ALG"</span>
ciphertext <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>plaintext<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>
plaintext <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>ciphertext<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 aes_cbc.py
01910e4bd6932674dba9bebd4fdf6cf2
b&#39;Demo AF_ALG&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>AES-GCM encrypt/decrypt via AF_ALG</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># need python 3.6 or above &amp; Linux >=4.9</span>
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> os

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">create_alg</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_ALG<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_SEQPACKET<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> taglen<span class="token punctuation">,</span> plaintext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" doing aes-gcm encrypt

    :param key: the aes symmetric key
    :param iv: initial vector
    :param assoc: associated data (integrity protection)
    :param taglen: authenticator tag len
    :param plaintext: plain text data
    """</span>

    assoclen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>assoc<span class="token punctuation">)</span>
    ciphertext <span class="token operator">=</span> <span class="token boolean">None</span>
    tag <span class="token operator">=</span> <span class="token boolean">None</span>

    <span class="token keyword">with</span> create_alg<span class="token punctuation">(</span><span class="token string">'aead'</span><span class="token punctuation">,</span> <span class="token string">'gcm(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> algo<span class="token punctuation">:</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_AEAD_AUTHSIZE<span class="token punctuation">,</span>
                        <span class="token boolean">None</span><span class="token punctuation">,</span>
                        assoclen<span class="token punctuation">)</span>

        op<span class="token punctuation">,</span> _ <span class="token operator">=</span> algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> op<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> assoc <span class="token operator">+</span> plaintext
            op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span><span class="token punctuation">[</span>msg<span class="token punctuation">]</span><span class="token punctuation">,</span>
                             op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_ENCRYPT<span class="token punctuation">,</span>
                             iv<span class="token operator">=</span>iv<span class="token punctuation">,</span>
                             assoclen<span class="token operator">=</span>assoclen<span class="token punctuation">)</span>

            res <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>assoclen <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span> <span class="token operator">+</span> taglen<span class="token punctuation">)</span>
            ciphertext <span class="token operator">=</span> res<span class="token punctuation">[</span>assoclen<span class="token punctuation">:</span><span class="token operator">-</span>taglen<span class="token punctuation">]</span>
            tag <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token operator">-</span>taglen<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> ciphertext<span class="token punctuation">,</span> tag


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" doing aes-gcm decrypt

    :param key: the AES symmetric key
    :param iv: initial vector
    :param assoc: associated data (integrity protection)
    :param tag: the GCM authenticator tag
    :param ciphertext: cipher text data
    """</span>
    plaintext <span class="token operator">=</span> <span class="token boolean">None</span>
    assoclen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>assoc<span class="token punctuation">)</span>

    <span class="token keyword">with</span> create_alg<span class="token punctuation">(</span><span class="token string">'aead'</span><span class="token punctuation">,</span> <span class="token string">'gcm(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> algo<span class="token punctuation">:</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_AEAD_AUTHSIZE<span class="token punctuation">,</span>
                        <span class="token boolean">None</span><span class="token punctuation">,</span>
                        assoclen<span class="token punctuation">)</span>
        op<span class="token punctuation">,</span> _ <span class="token operator">=</span> algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> op<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> assoc <span class="token operator">+</span> ciphertext <span class="token operator">+</span> tag
            op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span><span class="token punctuation">[</span>msg<span class="token punctuation">]</span><span class="token punctuation">,</span>
                             op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_DECRYPT<span class="token punctuation">,</span> iv<span class="token operator">=</span>iv<span class="token punctuation">,</span>
                             assoclen<span class="token operator">=</span>assoclen<span class="token punctuation">)</span>

            taglen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
            res <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">-</span> taglen<span class="token punctuation">)</span>
            plaintext <span class="token operator">=</span> res<span class="token punctuation">[</span>assoclen<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> plaintext

key <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
iv  <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
assoc <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

plaintext <span class="token operator">=</span> <span class="token string">b"Hello AES-GCM"</span>
ciphertext<span class="token punctuation">,</span> tag <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> plaintext<span class="token punctuation">)</span>
plaintext <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 aes_gcm.py
2e27b67234e01bcb0ab6b451f4f870ce
b&#39;Hello AES-GCM&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>AES-GCM encrypt/decrypt file with sendfile</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># need python 3.6 or above &amp; Linux >=4.9</span>
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> os

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">create_alg</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_ALG<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_SEQPACKET<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> taglen<span class="token punctuation">,</span> pfile<span class="token punctuation">)</span><span class="token punctuation">:</span>
    assoclen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>assoc<span class="token punctuation">)</span>
    ciphertext <span class="token operator">=</span> <span class="token boolean">None</span>
    tag <span class="token operator">=</span> <span class="token boolean">None</span>

    pfd <span class="token operator">=</span> pfile<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    offset <span class="token operator">=</span> <span class="token number">0</span>
    st <span class="token operator">=</span> os<span class="token punctuation">.</span>fstat<span class="token punctuation">(</span>pfd<span class="token punctuation">)</span>
    totalbytes <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size

    <span class="token keyword">with</span> create_alg<span class="token punctuation">(</span><span class="token string">'aead'</span><span class="token punctuation">,</span> <span class="token string">'gcm(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> algo<span class="token punctuation">:</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_AEAD_AUTHSIZE<span class="token punctuation">,</span>
                        <span class="token boolean">None</span><span class="token punctuation">,</span>
                        assoclen<span class="token punctuation">)</span>

        op<span class="token punctuation">,</span> _ <span class="token operator">=</span> algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> op<span class="token punctuation">:</span>
            op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span>op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_ENCRYPT<span class="token punctuation">,</span>
                             iv<span class="token operator">=</span>iv<span class="token punctuation">,</span>
                             assoclen<span class="token operator">=</span>assoclen<span class="token punctuation">,</span>
                             flags<span class="token operator">=</span>socket<span class="token punctuation">.</span>MSG_MORE<span class="token punctuation">)</span>

            op<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>assoc<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>MSG_MORE<span class="token punctuation">)</span>

            <span class="token comment"># using sendfile to encrypt file data</span>
            os<span class="token punctuation">.</span>sendfile<span class="token punctuation">(</span>op<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pfd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> totalbytes<span class="token punctuation">)</span>

            res <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>assoclen <span class="token operator">+</span> totalbytes <span class="token operator">+</span> taglen<span class="token punctuation">)</span>
            ciphertext <span class="token operator">=</span> res<span class="token punctuation">[</span>assoclen<span class="token punctuation">:</span><span class="token operator">-</span>taglen<span class="token punctuation">]</span>
            tag <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token operator">-</span>taglen<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> ciphertext<span class="token punctuation">,</span> tag


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plaintext <span class="token operator">=</span> <span class="token boolean">None</span>
    assoclen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>assoc<span class="token punctuation">)</span>

    <span class="token keyword">with</span> create_alg<span class="token punctuation">(</span><span class="token string">'aead'</span><span class="token punctuation">,</span> <span class="token string">'gcm(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> algo<span class="token punctuation">:</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_AEAD_AUTHSIZE<span class="token punctuation">,</span>
                        <span class="token boolean">None</span><span class="token punctuation">,</span>
                        assoclen<span class="token punctuation">)</span>
        op<span class="token punctuation">,</span> _ <span class="token operator">=</span> algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> op<span class="token punctuation">:</span>
            msg <span class="token operator">=</span> assoc <span class="token operator">+</span> ciphertext <span class="token operator">+</span> tag
            op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span><span class="token punctuation">[</span>msg<span class="token punctuation">]</span><span class="token punctuation">,</span>
                             op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_DECRYPT<span class="token punctuation">,</span> iv<span class="token operator">=</span>iv<span class="token punctuation">,</span>
                             assoclen<span class="token operator">=</span>assoclen<span class="token punctuation">)</span>

            taglen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
            res <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">-</span> taglen<span class="token punctuation">)</span>
            plaintext <span class="token operator">=</span> res<span class="token punctuation">[</span>assoclen<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> plaintext

key <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
iv  <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
assoc <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"usage: cmd plain"</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

plain <span class="token operator">=</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pf<span class="token punctuation">:</span>
    ciphertext<span class="token punctuation">,</span> tag <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> pf<span class="token punctuation">)</span>
    plaintext <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>ciphertext<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>plaintext<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ echo &quot;Test AES-GCM with sendfile&quot; &gt; plain.txt
$ python3 aes_gcm.py plain.txt
b3800044520ed07fa7f20b29c2695bae9ab596065359db4f009dd6
b&#39;Test AES-GCM with sendfile\n&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Compare the performance of AF_ALG to cryptography</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># need python 3.6 or above &amp; Linux >=4.9</span>
<span class="token keyword">import</span> contextlib
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

<span class="token keyword">from</span> cryptography<span class="token punctuation">.</span>hazmat<span class="token punctuation">.</span>primitives<span class="token punctuation">.</span>ciphers<span class="token punctuation">.</span>aead <span class="token keyword">import</span> AESGCM

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">create_alg</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_ALG<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_SEQPACKET<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> taglen<span class="token punctuation">,</span> op<span class="token punctuation">,</span> pfile<span class="token punctuation">,</span> psize<span class="token punctuation">)</span><span class="token punctuation">:</span>
    assoclen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>assoc<span class="token punctuation">)</span>
    ciphertext <span class="token operator">=</span> <span class="token boolean">None</span>
    tag <span class="token operator">=</span> <span class="token boolean">None</span>
    offset <span class="token operator">=</span> <span class="token number">0</span>

    pfd <span class="token operator">=</span> pfile<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    totalbytes <span class="token operator">=</span> psize

    op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span>op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_ENCRYPT<span class="token punctuation">,</span>
                     iv<span class="token operator">=</span>iv<span class="token punctuation">,</span>
                     assoclen<span class="token operator">=</span>assoclen<span class="token punctuation">,</span>
                     flags<span class="token operator">=</span>socket<span class="token punctuation">.</span>MSG_MORE<span class="token punctuation">)</span>

    op<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>assoc<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>MSG_MORE<span class="token punctuation">)</span>

    <span class="token comment"># using sendfile to encrypt file data</span>
    os<span class="token punctuation">.</span>sendfile<span class="token punctuation">(</span>op<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pfd<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> totalbytes<span class="token punctuation">)</span>

    res <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>assoclen <span class="token operator">+</span> totalbytes <span class="token operator">+</span> taglen<span class="token punctuation">)</span>
    ciphertext <span class="token operator">=</span> res<span class="token punctuation">[</span>assoclen<span class="token punctuation">:</span><span class="token operator">-</span>taglen<span class="token punctuation">]</span>
    tag <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token operator">-</span>taglen<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> ciphertext<span class="token punctuation">,</span> tag


<span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> op<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span><span class="token punctuation">:</span>
    plaintext <span class="token operator">=</span> <span class="token boolean">None</span>
    assoclen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>assoc<span class="token punctuation">)</span>

    msg <span class="token operator">=</span> assoc <span class="token operator">+</span> ciphertext <span class="token operator">+</span> tag
    op<span class="token punctuation">.</span>sendmsg_afalg<span class="token punctuation">(</span><span class="token punctuation">[</span>msg<span class="token punctuation">]</span><span class="token punctuation">,</span>
                     op<span class="token operator">=</span>socket<span class="token punctuation">.</span>ALG_OP_DECRYPT<span class="token punctuation">,</span> iv<span class="token operator">=</span>iv<span class="token punctuation">,</span>
                     assoclen<span class="token operator">=</span>assoclen<span class="token punctuation">)</span>

    taglen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>
    res <span class="token operator">=</span> op<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">-</span> taglen<span class="token punctuation">)</span>
    plaintext <span class="token operator">=</span> res<span class="token punctuation">[</span>assoclen<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">return</span> plaintext


key <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
iv  <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span>
assoc <span class="token operator">=</span> os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span>
assoclen <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>assoc<span class="token punctuation">)</span>

count <span class="token operator">=</span> <span class="token number">1000000</span>
plain <span class="token operator">=</span> <span class="token string">"tmp.rand"</span>

<span class="token comment"># crate a tmp file</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>os<span class="token punctuation">.</span>urandom<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    f<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment"># profile AF_ALG with sendfile (zero-copy)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pf<span class="token punctuation">,</span>\
     create_alg<span class="token punctuation">(</span><span class="token string">'aead'</span><span class="token punctuation">,</span> <span class="token string">'gcm(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> enc_algo<span class="token punctuation">,</span>\
     create_alg<span class="token punctuation">(</span><span class="token string">'aead'</span><span class="token punctuation">,</span> <span class="token string">'gcm(aes)'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> dec_algo<span class="token punctuation">:</span>

    enc_algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    enc_algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_AEAD_AUTHSIZE<span class="token punctuation">,</span>
                        <span class="token boolean">None</span><span class="token punctuation">,</span>
                        assoclen<span class="token punctuation">)</span>

    dec_algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_KEY<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    dec_algo<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_ALG<span class="token punctuation">,</span>
                        socket<span class="token punctuation">.</span>ALG_SET_AEAD_AUTHSIZE<span class="token punctuation">,</span>
                        <span class="token boolean">None</span><span class="token punctuation">,</span>
                        assoclen<span class="token punctuation">)</span>

    enc_op<span class="token punctuation">,</span> _ <span class="token operator">=</span> enc_algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    dec_op<span class="token punctuation">,</span> _ <span class="token operator">=</span> dec_algo<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>

    st <span class="token operator">=</span> os<span class="token punctuation">.</span>fstat<span class="token punctuation">(</span>pf<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    psize <span class="token operator">=</span> st<span class="token punctuation">.</span>st_size

    <span class="token keyword">with</span> enc_op<span class="token punctuation">,</span> dec_op<span class="token punctuation">:</span>

        s <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>
            ciphertext<span class="token punctuation">,</span> tag <span class="token operator">=</span> encrypt<span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> enc_op<span class="token punctuation">,</span> pf<span class="token punctuation">,</span> psize<span class="token punctuation">)</span>
            plaintext <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>key<span class="token punctuation">,</span> iv<span class="token punctuation">,</span> assoc<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> dec_op<span class="token punctuation">,</span> ciphertext<span class="token punctuation">)</span>

        cost <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"total cost time: </span><span class="token interpolation"><span class="token punctuation">{</span>cost<span class="token punctuation">}</span></span><span class="token string">. [AF_ALG]"</span></span><span class="token punctuation">)</span>


<span class="token comment"># profile cryptography (no zero-copy)</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>plain<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pf<span class="token punctuation">:</span>

    aesgcm <span class="token operator">=</span> AESGCM<span class="token punctuation">(</span>key<span class="token punctuation">)</span>

    s <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pf<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        plaintext <span class="token operator">=</span> pf<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ciphertext <span class="token operator">=</span> aesgcm<span class="token punctuation">.</span>encrypt<span class="token punctuation">(</span>iv<span class="token punctuation">,</span> plaintext<span class="token punctuation">,</span> assoc<span class="token punctuation">)</span>
        plaintext <span class="token operator">=</span> aesgcm<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>iv<span class="token punctuation">,</span> ciphertext<span class="token punctuation">,</span> assoc<span class="token punctuation">)</span>

    cost <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"total cost time: </span><span class="token interpolation"><span class="token punctuation">{</span>cost<span class="token punctuation">}</span></span><span class="token string">. [cryptography]"</span></span><span class="token punctuation">)</span>

<span class="token comment"># clean up</span>
os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>plain<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3 aes-gcm.py
total cost time: 15.317010641098022. [AF_ALG]
total cost time: 50.256704807281494. [cryptography]</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Sniffer IP packets</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct

<span class="token comment"># ref: IP protocol numbers</span>
PROTO_MAP <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token string">"ICMP"</span><span class="token punctuation">,</span>
        <span class="token number">2</span> <span class="token punctuation">:</span> <span class="token string">"IGMP"</span><span class="token punctuation">,</span>
        <span class="token number">6</span> <span class="token punctuation">:</span> <span class="token string">"TCP"</span><span class="token punctuation">,</span>
        <span class="token number">17</span><span class="token punctuation">:</span> <span class="token string">"UDP"</span><span class="token punctuation">,</span>
        <span class="token number">27</span><span class="token punctuation">:</span> <span class="token string">"RDP"</span><span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">IP</span><span class="token punctuation">(</span>Structure<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' IP header Structure

    In linux api, it define as below:

    strcut ip {
        u_char         ip_hl:4; /* header_len */
        u_char         ip_v:4;  /* version */
        u_char         ip_tos;  /* type of service */
        short          ip_len;  /* total len */
        u_short        ip_id;   /* identification */
        short          ip_off;  /* offset field */
        u_char         ip_ttl;  /* time to live */
        u_char         ip_p;    /* protocol */
        u_short        ip_sum;  /* checksum */
        struct in_addr ip_src;  /* source */
        struct in_addr ip_dst;  /* destination */
    };
    '''</span>
    _fields_ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">"ip_hl"</span> <span class="token punctuation">,</span> c_ubyte<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 4 bit</span>
                <span class="token punctuation">(</span><span class="token string">"ip_v"</span>  <span class="token punctuation">,</span> c_ubyte<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 1 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_tos"</span><span class="token punctuation">,</span> c_uint8<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 2 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_len"</span><span class="token punctuation">,</span> c_uint16<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># 4 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_id"</span> <span class="token punctuation">,</span> c_uint16<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># 6 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_off"</span><span class="token punctuation">,</span> c_uint16<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># 8 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_ttl"</span><span class="token punctuation">,</span> c_uint8<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 9 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_p"</span>  <span class="token punctuation">,</span> c_uint8<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment"># 10 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_sum"</span><span class="token punctuation">,</span> c_uint16<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># 12 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_src"</span><span class="token punctuation">,</span> c_uint32<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment"># 16 byte</span>
                <span class="token punctuation">(</span><span class="token string">"ip_dst"</span><span class="token punctuation">,</span> c_uint32<span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment"># 20 byte</span>

    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> buf<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">.</span>from_buffer_copy<span class="token punctuation">(</span>buf<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> buf<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        src <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">"&lt;L"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>ip_src<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>src <span class="token operator">=</span> socket<span class="token punctuation">.</span>inet_ntoa<span class="token punctuation">(</span>src<span class="token punctuation">)</span>
        dst <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">"&lt;L"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>ip_dst<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dst <span class="token operator">=</span> socket<span class="token punctuation">.</span>inet_ntoa<span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>proto <span class="token operator">=</span> PROTO_MAP<span class="token punctuation">[</span>self<span class="token punctuation">.</span>ip_p<span class="token punctuation">]</span>
        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{} Not in map"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>ip_p<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span>

host <span class="token operator">=</span> <span class="token string">'0.0.0.0'</span>
s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>
                  socket<span class="token punctuation">.</span>SOCK_RAW<span class="token punctuation">,</span>
                  socket<span class="token punctuation">.</span>IPPROTO_ICMP<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>IPPROTO_IP<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>IP_HDRINCL<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Sniffer start..."</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        buf <span class="token operator">=</span> s<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">65535</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        ip_header <span class="token operator">=</span> IP<span class="token punctuation">(</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{0}: {1} -> {2}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ip_header<span class="token punctuation">.</span>proto<span class="token punctuation">,</span>
                                       ip_header<span class="token punctuation">.</span>src<span class="token punctuation">,</span>
                                       ip_header<span class="token punctuation">.</span>dst<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">python sniffer.py
Sniffer start...
ICMP: 127.0.0.1 -&gt; 127.0.0.1
ICMP: 127.0.0.1 -&gt; 127.0.0.1
ICMP: 127.0.0.1 -&gt; 127.0.0.1</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 2)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ ping -c 3 localhost
PING localhost (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.063 ms
64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=0.087 ms
64 bytes from 127.0.0.1: icmp_seq=2 ttl=64 time=0.159 ms

--- localhost ping statistics ---
3 packets transmitted, 3 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.063/0.103/0.159/0.041 ms</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Sniffer TCP packet</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment">#!/usr/bin/env python3.6</span>
<span class="token triple-quoted-string string">"""
Based on RFC-793, the following figure shows the TCP header format:

0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

In linux api (uapi/linux/tcp.h), it defines the TCP header:

struct tcphdr {
    __be16  source;
    __be16  dest;
    __be32  seq;
    __be32  ack_seq;
#if defined(__LITTLE_ENDIAN_BITFIELD)
    __u16   res1:4,
            doff:4,
            fin:1,
            syn:1,
            rst:1,
            psh:1,
            ack:1,
            urg:1,
            ece:1,
            cwr:1;
#elif defined(__BIG_ENDIAN_BITFIELD)
    __u16   doff:4,
            res1:4,
            cwr:1,
            ece:1,
            urg:1,
            ack:1,
            psh:1,
            rst:1,
            syn:1,
            fin:1;
#else
#error      "Adjust your &lt;asm/byteorder.h> defines"
#endif
    __be16  window;
    __sum16 check;
    __be16  urg_ptr;
};
"""</span>
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> platform

<span class="token keyword">from</span> struct <span class="token keyword">import</span> unpack
<span class="token keyword">from</span> contextlib <span class="token keyword">import</span> contextmanager

un <span class="token operator">=</span> platform<span class="token punctuation">.</span>system<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> un <span class="token operator">!=</span> <span class="token string">"Linux"</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>un<span class="token punctuation">}</span></span><span class="token string"> is not supported!"</span></span><span class="token punctuation">)</span>
    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

@contextmanager
<span class="token keyword">def</span> <span class="token function">create_socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' Create a TCP raw socket '''</span>
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>
                      socket<span class="token punctuation">.</span>SOCK_RAW<span class="token punctuation">,</span>
                      socket<span class="token punctuation">.</span>IPPROTO_TCP<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> s
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> create_socket<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> s<span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            pkt<span class="token punctuation">,</span> addr <span class="token operator">=</span> s<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">65535</span><span class="token punctuation">)</span>

            <span class="token comment"># the first 20 bytes are ip header</span>
            iphdr <span class="token operator">=</span> unpack<span class="token punctuation">(</span><span class="token string">'!BBHHHBBH4s4s'</span><span class="token punctuation">,</span> pkt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            iplen <span class="token operator">=</span> <span class="token punctuation">(</span>iphdr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0xf</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>

            <span class="token comment"># the next 20 bytes are tcp header</span>
            tcphdr <span class="token operator">=</span> unpack<span class="token punctuation">(</span><span class="token string">'!HHLLBBHHH'</span><span class="token punctuation">,</span> pkt<span class="token punctuation">[</span>iplen<span class="token punctuation">:</span>iplen<span class="token operator">+</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            source <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            dest <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
            seq <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
            ack_seq <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
            dr <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>
            flags <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>
            window <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>
            check <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span>
            urg_ptr <span class="token operator">=</span> tcphdr<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span>

            doff <span class="token operator">=</span> dr <span class="token operator">>></span> <span class="token number">4</span>
            fin <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x01</span>
            syn <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x02</span>
            rst <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x04</span>
            psh <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x08</span>
            ack <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x10</span>
            urg <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x20</span>
            ece <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x40</span>
            cwr <span class="token operator">=</span> flags <span class="token operator">&amp;</span> <span class="token number">0x80</span>

            tcplen <span class="token operator">=</span> <span class="token punctuation">(</span>doff<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span>
            h_size <span class="token operator">=</span> iplen <span class="token operator">+</span> tcplen

            <span class="token comment">#get data from the packet</span>
            data <span class="token operator">=</span> pkt<span class="token punctuation">[</span>h_size<span class="token punctuation">:</span><span class="token punctuation">]</span>

            <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------ TCP_HEADER --------------"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Source Port:           </span><span class="token interpolation"><span class="token punctuation">{</span>source<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Destination Port:      </span><span class="token interpolation"><span class="token punctuation">{</span>dest<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sequence Number:       </span><span class="token interpolation"><span class="token punctuation">{</span>seq<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Acknowledgment Number: </span><span class="token interpolation"><span class="token punctuation">{</span>ack_seq<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Data offset:           </span><span class="token interpolation"><span class="token punctuation">{</span>doff<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"FIN:                   </span><span class="token interpolation"><span class="token punctuation">{</span>fin<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SYN:                   </span><span class="token interpolation"><span class="token punctuation">{</span>syn<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"RST:                   </span><span class="token interpolation"><span class="token punctuation">{</span>rst<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"PSH:                   </span><span class="token interpolation"><span class="token punctuation">{</span>psh<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ACK:                   </span><span class="token interpolation"><span class="token punctuation">{</span>ack<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"URG:                   </span><span class="token interpolation"><span class="token punctuation">{</span>urg<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ECE:                   </span><span class="token interpolation"><span class="token punctuation">{</span>ece<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"CWR:                   </span><span class="token interpolation"><span class="token punctuation">{</span>cwr<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Window:                </span><span class="token interpolation"><span class="token punctuation">{</span>window<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Checksum:              </span><span class="token interpolation"><span class="token punctuation">{</span>check<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Urgent Point:          </span><span class="token interpolation"><span class="token punctuation">{</span>urg_ptr<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------- DATA -----------------"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python3.6 tcp.py
------------ TCP_HEADER --------------
Source Port:           38352
Destination Port:      8000
Sequence Number:       2907801591
Acknowledgment Number: 398995857
Data offset:           8
FIN:                   0
SYN:                   0
RST:                   0
PSH:                   8
ACK:                   16
URG:                   0
ECE:                   0
CWR:                   0
Window:                342
Checksum:              65142
Urgent Point:          0
--------------- DATA -----------------
b&#39;GET / HTTP/1.1\r\nHost: localhost:8000\r\nUser-Agent: curl/7.47.0\r\nAccept: */*\r\n\r\n&#39;</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Sniffer ARP packet</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token triple-quoted-string string">"""
Ehternet Packet Header

struct ethhdr {
    unsigned char h_dest[ETH_ALEN];   /* destination eth addr */
    unsigned char h_source[ETH_ALEN]; /* source ether addr    */
    __be16        h_proto;            /* packet type ID field */
} __attribute__((packed));

ARP Packet Header

struct arphdr {
    uint16_t htype;    /* Hardware Type           */
    uint16_t ptype;    /* Protocol Type           */
    u_char   hlen;     /* Hardware Address Length */
    u_char   plen;     /* Protocol Address Length */
    uint16_t opcode;   /* Operation Code          */
    u_char   sha[6];   /* Sender hardware address */
    u_char   spa[4];   /* Sender IP address       */
    u_char   tha[6];   /* Target hardware address */
    u_char   tpa[4];   /* Target IP address       */
};
"""</span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> struct
<span class="token keyword">import</span> binascii

rawSocket <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_PACKET<span class="token punctuation">,</span>
                          socket<span class="token punctuation">.</span>SOCK_RAW<span class="token punctuation">,</span>
                          socket<span class="token punctuation">.</span>htons<span class="token punctuation">(</span><span class="token number">0x0003</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>

    packet <span class="token operator">=</span> rawSocket<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">)</span>
    ethhdr <span class="token operator">=</span> packet<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">]</span>
    eth <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"!6s6s2s"</span><span class="token punctuation">,</span> ethhdr<span class="token punctuation">)</span>

    arphdr <span class="token operator">=</span> packet<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">42</span><span class="token punctuation">]</span>
    arp <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">"2s2s1s1s2s6s4s6s4s"</span><span class="token punctuation">,</span> arphdr<span class="token punctuation">)</span>
    <span class="token comment"># skip non-ARP packets</span>
    ethtype <span class="token operator">=</span> eth<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> ethtype <span class="token operator">!=</span> <span class="token string">'\x08\x06'</span><span class="token punctuation">:</span> <span class="token keyword">continue</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-------------- ETHERNET_FRAME -------------"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Dest MAC:        "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>eth<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Source MAC:      "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>eth<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Type:            "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>ethtype<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"--------------- ARP_HEADER ----------------"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hardware type:   "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Protocol type:   "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Hardware size:   "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Protocol size:   "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Opcode:          "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Source MAC:      "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Source IP:       "</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>inet_ntoa<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Dest MAC:        "</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Dest IP:         "</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>inet_ntoa<span class="token punctuation">(</span>arp<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-------------------------------------------"</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ python arp.py
-------------- ETHERNET_FRAME -------------
Dest MAC:         ffffffffffff
Source MAC:       f0257252f5ca
Type:             0806
--------------- ARP_HEADER ----------------
Hardware type:    0001
Protocol type:    0800
Hardware size:    06
Protocol size:    04
Opcode:           0001
Source MAC:       f0257252f5ca
Source IP:        140.112.91.254
Dest MAC:         000000000000
Dest IP:          140.112.91.20
-------------------------------------------</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.pythonsheets.com/">Acesse a Referência original 1:</a>
<a href="https://www.pythoncheatsheet.org/">Acesse a Referência original 2:</a></p></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACwUlEQVQ4y42UWU8UQRDHefFjGL+Arz6aKIlHMOFNXiSBqFEw0ZiIbtCAIYTIIYeGQ1dwOeKycigQD1DX5QwJEoSNirLdPdPbMz3dM73LqfFNaxjDrhiBpDLpY37dVf+q6gxKyM6mx4i2af9uZeyEIWKa2FlB9jKCr2FgHe8NBtISeH6UhnxWoFB2+0R0knKBYX1HGLuucguHHxt3j6mX98yxIBuq5jAeDzLOU/x2GGIj3wiL4+iUXpWpYlEtsY6cZaTW0OcZvTpTLc5qjBHP/xQMc8DgYIMRiLC/zBqo4M4qwova3FtKNaLWUc8ta6iGS4X1WBoMJFhyA828iFcdSUTaje4b1vuAYUn3rECBbDsvl3+ikWYz5BN2AmkpGJO45k4GK83qoyroE71l1mgn67oqkt8R/kqEg1vPyoE7PFhkjTQbMPXCzvCuNQziz7P9efLTtP4xTOtPKRjUgELdDKKN6/ADrjycqDup4hr27nNhLyVTfaz1nNz4FYNoQef+Mg5SQ7T1WarrioCBWkXPynlfqQXibRWMC4MbIy1mQ7YKB9jzCt5bakFVRNrZu0eGwfDTYqvljC0TaLTT6LwshIP0FIwJo+TLB32wivfctK4dWJnqZYEC0Zxjh9sM2IVU+fPlRIhND7D2QilV2s1e9YKqkz2s8bTzutF802KCvCAVhKNtbkU6WG8Jf3Xf7LvNZeJvGCbgecclWXIwGbgoyw8lF8YpKESWiAdDYYHDTTmOt75V4X/yDKnSlsjsMJ0L09rjCtQCxost+QMBeX3/CpSHsHF6e6WKBPIBANQGpHq4yRQKw4qGSKjYurBvLVgkIAvpXbG9POHUphy7Idvx59sPc+0HuXZdlqo9ocaeMCDhIPrfloTLqcvPR+jCGI1O6NFxHdoAZIOuhrLf5TFwldCIaeAtY3G3sbe9AXt6SXa133dG1a0ljAUNAAAAAElFTkSuQmCC" alt="Reativa" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/d2742f2dddd737dec60ee2a5226edb06/000d3/icon.png 1x,
/static/d2742f2dddd737dec60ee2a5226edb06/bc2a0/icon.png 1.5x,
/static/d2742f2dddd737dec60ee2a5226edb06/89cf4/icon.png 2x" /><img loading="lazy" width="50" height="50" srcset="/static/d2742f2dddd737dec60ee2a5226edb06/000d3/icon.png 1x,
/static/d2742f2dddd737dec60ee2a5226edb06/bc2a0/icon.png 1.5x,
/static/d2742f2dddd737dec60ee2a5226edb06/89cf4/icon.png 2x" src="/static/d2742f2dddd737dec60ee2a5226edb06/000d3/icon.png" alt="Reativa" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p><strong>Está curtindo os conteúdos da Reativa? Quer que a gente te ajude a ser um dev melhor?<!-- --> </strong> <!-- --> <a href="http://bit.ly/form-reativa" target="_blank" rel="noopener noreferrer">Deixe seu melhor email aqui.</a> </p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/average_by/">← <!-- -->Python como usar o average_by</a></li><li><a rel="next" href="/python-concurrency/">Python tudo sobre Concurrency<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2020<!-- -->, Sua melhor escolha para aprender programação:<!-- --> <a href="https://reativa.dev">Reativa Tecnologia</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-155080700-5', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/python-socket/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-da4c9f678cc075cd8c26.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-2642abeb110b544c12ef.js"],"component---src-pages-404-js":["/component---src-pages-404-js-ba8fab707f547b8d2140.js"],"component---src-pages-index-js":["/component---src-pages-index-js-511e09b2f0f1386b8494.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-2642abeb110b544c12ef.js" async=""></script><script src="/commons-2011af21236d35f89581.js" async=""></script><script src="/app-da4c9f678cc075cd8c26.js" async=""></script><script src="/netlify-identity-widget-71f3202b04975b5e224a.js" async=""></script><script src="/styles-989bb08664f2608f37ec.js" async=""></script><script src="/webpack-runtime-002569f02672c1c38772.js" async=""></script></body></html>