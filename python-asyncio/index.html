<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.9);font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:hsla(0,0%,0%,0.59);font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:hsla(0,0%,0%,0.9);font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#007acc;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}a.gatsby-resp-image-link{box-shadow:none;}</style><style data-href="/styles.1d07f1255d05a1395a48.css">@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-191cc9f50f3b76b9617cb383f19acb7d.woff2) format("woff2"),url(/static/montserrat-latin-100-370318464551d5f25b0f0a78f374faac.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-bdeaeb79db315697bd173a55b097dc18.woff2) format("woff2"),url(/static/montserrat-latin-100italic-ecf7d49386e8f265878e735db34a7c4b.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-85d5ef9db7f2dc6979172a4a3b2c57cb.woff2) format("woff2"),url(/static/montserrat-latin-200-1fc98e126a3d152549240e6244d7e669.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-49095760a498d024fe1a85a078850df9.woff2) format("woff2"),url(/static/montserrat-latin-200italic-fe46cf8b9462c820457d3bf537e4057f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-7c3daf12b706645b5d3710f863a4da04.woff2) format("woff2"),url(/static/montserrat-latin-300-8dc95fab9cf98d02ca8d76e97d3dff60.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-f20b178ca2024a5eac8e42e6649db86c.woff2) format("woff2"),url(/static/montserrat-latin-300italic-3fe16939288856e8e828fa2661bf2354.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-bc3aa95dca08f5fee5291e34959c27bc.woff2) format("woff2"),url(/static/montserrat-latin-400-8102c4838f9e3d08dad644290a9cb701.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-5cad650422a7184467af5a4d17b264c4.woff2) format("woff2"),url(/static/montserrat-latin-400italic-d191f22af3bb50902b99ac577f81a322.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-92d16e458625f4d2c8940f6bdca0ff09.woff2) format("woff2"),url(/static/montserrat-latin-500-8b763220218ffc11c57c84ddb80e7b26.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-47bfcca6b69d6a9acca7a8bff17193e2.woff2) format("woff2"),url(/static/montserrat-latin-500italic-72c01f753c3940c0b9cb6bf2389caddf.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-6fb1b5623e528e27c18658fecf5ee0ee.woff2) format("woff2"),url(/static/montserrat-latin-600-7c839d15a6f54e7025ba8c0c4b333e8f.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-60789af1c9338ed1a9546722ec54b4f7.woff2) format("woff2"),url(/static/montserrat-latin-600italic-f3d4de8d0afb19e777c79032ce828e3d.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-39d93cf678c740f9f6b2b1cfde34bee3.woff2) format("woff2"),url(/static/montserrat-latin-700-80f10bd382f0df1cd650fec59f3c9394.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-ba136d97b14e82284dd595e257f11c47.woff2) format("woff2"),url(/static/montserrat-latin-700italic-8c98142b425630821139c24bd1698700.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-b7018be9ed6cd94da8b6675b3a468c3b.woff2) format("woff2"),url(/static/montserrat-latin-800-9a9befcf50d64f9d2d19d8b1d1984add.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-540ffdd223d1a9ad3d4e678e1a23372e.woff2) format("woff2"),url(/static/montserrat-latin-800italic-897086f99f4e1f45e6b1e9368527d0bc.woff) format("woff")}@font-face{font-family:Montserrat;font-style:normal;font-display:swap;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-58cd789700850375b834e8b6776002eb.woff2) format("woff2"),url(/static/montserrat-latin-900-26d42c9428780e545a540bbb50c84bce.woff) format("woff")}@font-face{font-family:Montserrat;font-style:italic;font-display:swap;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-451157bc8861fe54f523b3669a3def71.woff2) format("woff2"),url(/static/montserrat-latin-900italic-a8ec4957e1c24f5793305763ad9845b3.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-b1158cfcd4aacb9d8fb61625e37af46a.woff2) format("woff2"),url(/static/merriweather-latin-300-cc7de05e166e90320d7d896e0f72a19d.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-8fe52a48089d6ebe46db0b8e7cc66263.woff2) format("woff2"),url(/static/merriweather-latin-300italic-e1331f5397c2a673f9d3765138debdb5.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-8276fdb72ae8f4714d4e6eba704cc39f.woff2) format("woff2"),url(/static/merriweather-latin-400-69f09800f4f6479d06e44eba837df872.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-3a9be9ea9f7aa4af6de7307df21d9fc0.woff2) format("woff2"),url(/static/merriweather-latin-400italic-d76079ed7541a433a54f79316de086e9.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-fa534be7ffa380e39a7f6e03bf9a5e03.woff2) format("woff2"),url(/static/merriweather-latin-700-ba56ea84b8084b7ff9677f50d3cd81bd.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-1ef5edaaa20ae53ea50399884c5e48c6.woff2) format("woff2"),url(/static/merriweather-latin-700italic-534bc9e7ce93c73d73426e46acd78092.woff) format("woff")}@font-face{font-family:Merriweather;font-style:normal;font-display:swap;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-7528fb70e8a4a82c7305e72ff43ac25f.woff2) format("woff2"),url(/static/merriweather-latin-900-3799b6e2f5ed3fcccf9d7a708d7419fa.woff) format("woff")}@font-face{font-family:Merriweather;font-style:italic;font-display:swap;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-e1b4d2aaa78e12ad84aaf8a56321e4c2.woff2) format("woff2"),url(/static/merriweather-latin-900italic-2ae22f731b3424e8dbb4b37f7ca6e708.woff) format("woff")}code[class*=language-],pre[class*=language-]{color:#f8f8f2;background:none;text-shadow:0 1px rgba(0,0,0,.3);font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em}:not(pre)>code[class*=language-],pre[class*=language-]{background:#272822}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#f8f8f2}.namespace{opacity:.7}.token.constant,.token.deleted,.token.property,.token.symbol,.token.tag{color:#f92672}.token.boolean,.token.number{color:#ae81ff}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#a6e22e}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url,.token.variable{color:#f8f8f2}.token.atrule,.token.attr-value,.token.class-name,.token.function{color:#e6db74}.token.keyword{color:#66d9ef}.token.important,.token.regex{color:#fd971f}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.18.12"/><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link rel="preconnect dns-prefetch" href="https://www.google-analytics.com"/><script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
  document,'script','https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2374911412821725'); // Insert your pixel ID here.
  fbq('track', 'PageView');
      </script><script>window.dataLayer = window.dataLayer || [];window.dataLayer.push({"platform":"plataforma-reativa"}); (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0], j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src= 'https://www.googletagmanager.com/gtm.js?id='+i+dl+'';f.parentNode.insertBefore(j,f); })(window,document,'script','dataLayer', 'GTM-KZH8KWD');</script><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><link rel="icon" href="/icons/icon-48x48.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=a4533d42454f73956ac7c2f680393b78"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=a4533d42454f73956ac7c2f680393b78"/><title data-react-helmet="true">Python tudo sobre Asyncio | Python para impacientes</title><meta data-react-helmet="true" name="description" content="======= asyncio.run New in Python 3.7 Future like object Future like object  other task Patch loop runner  Put blocking task into Executor Socket with asyncio…"/><meta data-react-helmet="true" property="og:title" content="Python tudo sobre Asyncio"/><meta data-react-helmet="true" property="og:description" content="======= asyncio.run New in Python 3.7 Future like object Future like object  other task Patch loop runner  Put blocking task into Executor Socket with asyncio…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Reativa"/><meta data-react-helmet="true" name="twitter:title" content="Python tudo sobre Asyncio"/><meta data-react-helmet="true" name="twitter:description" content="======= asyncio.run New in Python 3.7 Future like object Future like object  other task Patch loop runner  Put blocking task into Executor Socket with asyncio…"/><link as="script" rel="preload" href="/webpack-runtime-002569f02672c1c38772.js"/><link as="script" rel="preload" href="/styles-989bb08664f2608f37ec.js"/><link as="script" rel="preload" href="/netlify-identity-widget-71f3202b04975b5e224a.js"/><link as="script" rel="preload" href="/app-da4c9f678cc075cd8c26.js"/><link as="script" rel="preload" href="/commons-2011af21236d35f89581.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-2642abeb110b544c12ef.js"/><link as="fetch" rel="preload" href="/page-data/python-asyncio/page-data.json" crossorigin="anonymous"/></head><body><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KZH8KWD" height="0" width="0" style="display: none; visibility: hidden"></iframe></noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div style="margin-left:auto;margin-right:auto;max-width:42rem;padding:2.625rem 1.3125rem"><header><h3 style="font-family:Montserrat, sans-serif;margin-top:0"><a style="box-shadow:none;text-decoration:none;color:inherit" href="/">Python para impacientes</a></h3></header><main><article><header><h1 style="margin-top:1.75rem;margin-bottom:0">Python tudo sobre Asyncio</h1><p style="font-size:0.83255rem;line-height:1.75rem;display:block;margin-bottom:1.75rem">January 05, 2020</p></header><section><p>=======</p>
<h2>asyncio.run</h2>
<p><strong>New in Python 3.7</strong></p>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token operator">>></span><span class="token operator">></span> e <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>file_<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>e<span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> ret <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>read_file<span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Future like object</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys
<span class="token operator">>></span><span class="token operator">></span> PY_35 <span class="token operator">=</span> sys<span class="token punctuation">.</span>version_info <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">SlowObj</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__init__"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>_n <span class="token operator">=</span> n
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">if</span> PY_35<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">def</span> <span class="token function">__await__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__await__ sleep({})"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_n<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_n<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">return</span> self
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     obj <span class="token operator">=</span> <span class="token keyword">await</span> SlowObj<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
__init__
__await__ sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
ok</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Future like object <code class="language-text">__await__</code> other task</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> sys
<span class="token operator">>></span><span class="token operator">></span> PY_35 <span class="token operator">=</span> sys<span class="token punctuation">.</span>version_info <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">slow_task</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">SlowObj</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__init__"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>_n <span class="token operator">=</span> n
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">if</span> PY_35<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">def</span> <span class="token function">__await__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__await__"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">yield</span> <span class="token keyword">from</span> slow_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_n<span class="token punctuation">)</span><span class="token punctuation">.</span>__await__<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">yield</span> <span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_n<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">return</span> self
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     obj <span class="token operator">=</span> <span class="token keyword">await</span> SlowObj<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
__init__
__await__
ok</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Patch loop runner <code class="language-text">_run_once</code></h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">def</span> <span class="token function">_run_once</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     num_tasks <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_scheduled<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"num tasks in queue: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>num_tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token builtin">super</span><span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>SelectorEventLoop<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>_run_once<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> EventLoop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>SelectorEventLoop
<span class="token operator">>></span><span class="token operator">></span> EventLoop<span class="token punctuation">.</span>_run_once <span class="token operator">=</span> _run_once
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> EventLoop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> asyncio<span class="token punctuation">.</span>set_event_loop<span class="token punctuation">(</span>loop<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">task</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"sleep: {} sec"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> coro <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>task<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>coro<span class="token punctuation">)</span>
num tasks <span class="token keyword">in</span> queue<span class="token punctuation">:</span> <span class="token number">0</span>
num tasks <span class="token keyword">in</span> queue<span class="token punctuation">:</span> <span class="token number">1</span>
num tasks <span class="token keyword">in</span> queue<span class="token punctuation">:</span> <span class="token number">0</span>
sleep<span class="token punctuation">:</span> <span class="token number">3</span> sec
num tasks <span class="token keyword">in</span> queue<span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Put blocking task into Executor</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token operator">>></span><span class="token operator">></span> e <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">read_file</span><span class="token punctuation">(</span>file_<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         data <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>e<span class="token punctuation">,</span> f<span class="token punctuation">.</span>read<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> data
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> task <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>read_file<span class="token punctuation">(</span><span class="token string">'/etc/passwd'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> ret <span class="token operator">=</span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Socket with asyncio</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> socket

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">9527</span>
loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_recv<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> msg<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_sendall<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_accept<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>handler<span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>

loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 1)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 9527
Hello
Hello</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<p>output: (bash 2)</p>
<div class="gatsby-highlight" data-language="text"><pre style="counter-reset: linenumber NaN" class="language-text line-numbers"><code class="language-text">$ nc localhost 9527
World
World</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span></span></pre></div>
<h2>Event Loop with polling</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># using selectors</span>
<span class="token comment"># ref: PyCon 2015 - David Beazley</span>

<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> selectors
<span class="token keyword">from</span> collections <span class="token keyword">import</span> deque

@asyncio<span class="token punctuation">.</span>coroutine
<span class="token keyword">def</span> <span class="token function">read_wait</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">yield</span> <span class="token string">'read_wait'</span><span class="token punctuation">,</span> s

@asyncio<span class="token punctuation">.</span>coroutine
<span class="token keyword">def</span> <span class="token function">write_wait</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">yield</span> <span class="token string">'write_wait'</span><span class="token punctuation">,</span> s

<span class="token keyword">class</span> <span class="token class-name">Loop</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Simple loop prototype"""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ready <span class="token operator">=</span> deque<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>selector <span class="token operator">=</span> selectors<span class="token punctuation">.</span>DefaultSelector<span class="token punctuation">(</span><span class="token punctuation">)</span>

    @asyncio<span class="token punctuation">.</span>coroutine
    <span class="token keyword">def</span> <span class="token function">sock_accept</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> <span class="token keyword">from</span> read_wait<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token keyword">return</span> s<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>

    @asyncio<span class="token punctuation">.</span>coroutine
    <span class="token keyword">def</span> <span class="token function">sock_recv</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c<span class="token punctuation">,</span> mb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">yield</span> <span class="token keyword">from</span> read_wait<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
        <span class="token keyword">return</span> c<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>mb<span class="token punctuation">)</span>

    @asyncio<span class="token punctuation">.</span>coroutine
    <span class="token keyword">def</span> <span class="token function">sock_sendall</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> c<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> m<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> <span class="token keyword">from</span> write_wait<span class="token punctuation">(</span>c<span class="token punctuation">)</span>
            nsent <span class="token operator">=</span> c<span class="token punctuation">.</span>send<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
            m <span class="token operator">=</span> m<span class="token punctuation">[</span>nsent<span class="token punctuation">:</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">create_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> coro<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>ready<span class="token punctuation">.</span>append<span class="token punctuation">(</span>coro<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run_forever</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_run_once<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_run_once</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>ready<span class="token punctuation">:</span>
            events <span class="token operator">=</span> self<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> k<span class="token punctuation">,</span> _ <span class="token keyword">in</span> events<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>ready<span class="token punctuation">.</span>append<span class="token punctuation">(</span>k<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>unregister<span class="token punctuation">(</span>k<span class="token punctuation">.</span>fileobj<span class="token punctuation">)</span>

        <span class="token keyword">while</span> self<span class="token punctuation">.</span>ready<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>cur_t <span class="token operator">=</span> ready<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                op<span class="token punctuation">,</span> <span class="token operator">*</span>a <span class="token operator">=</span> self<span class="token punctuation">.</span>cur_t<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>
                <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token punctuation">)</span>
            <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
                <span class="token keyword">pass</span>

    <span class="token keyword">def</span> <span class="token function">read_wait</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>register<span class="token punctuation">(</span>s<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_READ<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cur_t<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">write_wait</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>selector<span class="token punctuation">.</span>register<span class="token punctuation">(</span>s<span class="token punctuation">,</span> selectors<span class="token punctuation">.</span>EVENT_WRITE<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cur_t<span class="token punctuation">)</span>

loop <span class="token operator">=</span> Loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">9527</span>

s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>
        socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>
        socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>
        socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span>
        socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

@asyncio<span class="token punctuation">.</span>coroutine
<span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> loop<span class="token punctuation">.</span>sock_recv<span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> msg<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">yield</span> <span class="token keyword">from</span> loop<span class="token punctuation">.</span>sock_sendall<span class="token punctuation">(</span>c<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

@asyncio<span class="token punctuation">.</span>coroutine
<span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        c<span class="token punctuation">,</span> addr <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token keyword">from</span> loop<span class="token punctuation">.</span>sock_accept<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>handler<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>

loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Transport and Protocol</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio

<span class="token keyword">class</span> <span class="token class-name">EchoProtocol</span><span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>Protocol<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">connection_made</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> transport<span class="token punctuation">)</span><span class="token punctuation">:</span>
        peername <span class="token operator">=</span> transport<span class="token punctuation">.</span>get_extra_info<span class="token punctuation">(</span><span class="token string">'peername'</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Connection from {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>peername<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transport <span class="token operator">=</span> transport

    <span class="token keyword">def</span> <span class="token function">data_received</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg <span class="token operator">=</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transport<span class="token punctuation">.</span>write<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
coro <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_server<span class="token punctuation">(</span>EchoProtocol<span class="token punctuation">,</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span> <span class="token number">5566</span><span class="token punctuation">)</span>
server <span class="token operator">=</span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>coro<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>server<span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># console 1</span>
$ <span class="token function">nc</span> localhost <span class="token number">5566</span>
Hello
Hello

<span class="token comment"># console 2</span>
$ <span class="token function">nc</span> localhost <span class="token number">5566</span>
World
World</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Transport and Protocol with SSL</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> ssl


<span class="token keyword">def</span> <span class="token function">make_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    head <span class="token operator">=</span> <span class="token string">b"HTTP/1.1 200 OK\r\n"</span>
    head <span class="token operator">+=</span> <span class="token string">b"Content-Type: text/html\r\n"</span>
    head <span class="token operator">+=</span> <span class="token string">b"\r\n"</span>
    <span class="token keyword">return</span> head


<span class="token keyword">def</span> <span class="token function">make_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    resp <span class="token operator">=</span> <span class="token string">b"&lt;html>"</span>
    resp <span class="token operator">+=</span> <span class="token string">b"&lt;h1>Hello SSL&lt;/h1>"</span>
    resp <span class="token operator">+=</span> <span class="token string">b"&lt;/html>"</span>
    <span class="token keyword">return</span> resp


sslctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_SSLv23<span class="token punctuation">)</span>
sslctx<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span>
    certfile<span class="token operator">=</span><span class="token string">"./root-ca.crt"</span><span class="token punctuation">,</span> keyfile<span class="token operator">=</span><span class="token string">"./root-ca.key"</span>
<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Service</span><span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>Protocol<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">connection_made</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tr<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>tr <span class="token operator">=</span> tr
        self<span class="token punctuation">.</span>total <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">data_received</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">:</span>
            resp <span class="token operator">=</span> make_header<span class="token punctuation">(</span><span class="token punctuation">)</span>
            resp <span class="token operator">+=</span> make_body<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>tr<span class="token punctuation">.</span>write<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tr<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    server <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>create_server<span class="token punctuation">(</span>
        Service<span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">4433</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span>sslctx
    <span class="token punctuation">)</span>
    <span class="token keyword">await</span> server<span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">try</span><span class="token punctuation">:</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ openssl genrsa -out root-ca.key <span class="token number">2048</span>
$ openssl req -x509 -new -nodes -key root-ca.key -days <span class="token number">365</span> -out root-ca.crt
$ python3 ssl_web_server.py

<span class="token comment"># then open browser: https://localhost:4433</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Asynchronous Iterator</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># ref: PEP-0492</span>
<span class="token comment"># need Python >= 3.5</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">AsyncIter</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>_it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__aiter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> self
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__anext__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             val <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_it<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">raise</span> StopAsyncIteration
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> val
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     it <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> AsyncIter<span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>What is asynchronous iterator</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">AsyncIter</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         self<span class="token punctuation">.</span>_it <span class="token operator">=</span> <span class="token builtin">iter</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">def</span> <span class="token function">__aiter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> self
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__anext__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             val <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_it<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">except</span> StopIteration<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">raise</span> StopAsyncIteration
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> val
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     _ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     running <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     it <span class="token operator">=</span> AsyncIter<span class="token punctuation">(</span>_<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">while</span> running<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">try</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             res <span class="token operator">=</span> <span class="token keyword">await</span> it<span class="token punctuation">.</span>__anext__<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             <span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">except</span> StopAsyncIteration<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>             running <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">1</span>
<span class="token number">2</span>
<span class="token number">3</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Asynchronous context manager</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># ref: PEP-0492</span>
<span class="token comment"># need Python >= 3.5</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">AsyncCtxMgr</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__aenter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__anter__"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">return</span> self
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__aexit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>exc<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__aexit__"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">with</span> AsyncCtxMgr<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"hello block"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"world block"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> t <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>world<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>hello<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
world block
__anter__
hello block
__aexit__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>What is asynchronous context manager</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">class</span> <span class="token class-name">AsyncManager</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__aenter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__aenter__"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">__aexit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token operator">*</span>exc_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"__aexit__"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">import</span> sys
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     mgr <span class="token operator">=</span> AsyncManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">await</span> mgr<span class="token punctuation">.</span>__aenter__<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"body"</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">await</span> mgr<span class="token punctuation">.</span>__aexit__<span class="token punctuation">(</span><span class="token operator">*</span>sys<span class="token punctuation">.</span>exc_info<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>foo<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
__aenter__
body
__aexit__</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>decorator <code class="language-text">@asynccontextmanager</code></h2>
<p><strong>New in Python 3.7</strong></p>
<ul>
<li>Issue <a href="https://bugs.python.org/issue29679">29679</a> - Add
@contextlib.asynccontextmanager</li>
</ul>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> contextlib <span class="token keyword">import</span> asynccontextmanager
<span class="token operator">>></span><span class="token operator">></span> @asynccontextmanager
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">coro</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">yield</span> msg
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">async</span> <span class="token keyword">with</span> coro<span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> m<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>         <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
Hello
done</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple asyncio connection pool</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> uuid

<span class="token keyword">class</span> <span class="token class-name">Transport</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loop<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token boolean">False</span>

        self<span class="token punctuation">.</span>_loop <span class="token operator">=</span> loop
        self<span class="token punctuation">.</span>_host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>_port <span class="token operator">=</span> port
        self<span class="token punctuation">.</span>_sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>
                socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_sock<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_uuid <span class="token operator">=</span> uuid<span class="token punctuation">.</span>uuid1<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">,</span> sock <span class="token operator">=</span> self<span class="token punctuation">.</span>_loop<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_sock
        host<span class="token punctuation">,</span> port <span class="token operator">=</span> self<span class="token punctuation">.</span>_host<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_port
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_connect<span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">sendall</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">,</span> sock <span class="token operator">=</span> self<span class="token punctuation">.</span>_loop<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_sock
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_sendall<span class="token punctuation">(</span>sock<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">recv</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">,</span> sock <span class="token operator">=</span> self<span class="token punctuation">.</span>_loop<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_sock
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_recv<span class="token punctuation">(</span>sock<span class="token punctuation">,</span> buf_size<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_sock<span class="token punctuation">:</span> self<span class="token punctuation">.</span>_sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">alive</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ret <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>_sock <span class="token keyword">else</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> ret

    @<span class="token builtin">property</span>
    <span class="token keyword">def</span> <span class="token function">uuid</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_uuid


<span class="token keyword">class</span> <span class="token class-name">ConnectionPool</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> loop<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> max_conn<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_host <span class="token operator">=</span> host
        self<span class="token punctuation">.</span>_port <span class="token operator">=</span> port
        self<span class="token punctuation">.</span>_max_conn <span class="token operator">=</span> max_conn
        self<span class="token punctuation">.</span>_loop <span class="token operator">=</span> loop

        conns <span class="token operator">=</span> <span class="token punctuation">[</span>Transport<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_conn<span class="token punctuation">)</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>_conns <span class="token operator">=</span> conns

    <span class="token keyword">def</span> <span class="token function">__await__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> _c <span class="token keyword">in</span> self<span class="token punctuation">.</span>_conns<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> <span class="token keyword">from</span> _c<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__await__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">def</span> <span class="token function">getconn</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> fut <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            fut <span class="token operator">=</span> self<span class="token punctuation">.</span>_loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> _c <span class="token keyword">in</span> self<span class="token punctuation">.</span>_conns<span class="token punctuation">:</span>
            <span class="token keyword">if</span> _c<span class="token punctuation">.</span>alive <span class="token keyword">and</span> <span class="token keyword">not</span> _c<span class="token punctuation">.</span>used<span class="token punctuation">:</span>
                _c<span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token boolean">True</span>
                fut<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>_c<span class="token punctuation">)</span>
                <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>self<span class="token punctuation">.</span>getconn<span class="token punctuation">,</span> fut<span class="token punctuation">)</span>

        <span class="token keyword">return</span> fut

    <span class="token keyword">def</span> <span class="token function">release</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> conn<span class="token punctuation">.</span>used<span class="token punctuation">:</span>
            <span class="token keyword">return</span>
        <span class="token keyword">for</span> _c <span class="token keyword">in</span> self<span class="token punctuation">.</span>_conns<span class="token punctuation">:</span>
            <span class="token keyword">if</span> _c<span class="token punctuation">.</span>uuid <span class="token operator">!=</span> conn<span class="token punctuation">.</span>uuid<span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            _c<span class="token punctuation">.</span>used <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword">break</span>

    <span class="token keyword">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> _c <span class="token keyword">in</span> self<span class="token punctuation">.</span>_conns<span class="token punctuation">:</span>
            _c<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>pool<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">:</span>
    conn <span class="token operator">=</span> <span class="token keyword">await</span> pool<span class="token punctuation">.</span>getconn<span class="token punctuation">(</span><span class="token punctuation">)</span>
    byte <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
    mesg <span class="token operator">=</span> <span class="token keyword">await</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    pool<span class="token punctuation">.</span>release<span class="token punctuation">(</span>conn<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'echo: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>mesg<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># creat connection pool</span>
        pool <span class="token operator">=</span> <span class="token keyword">await</span> ConnectionPool<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>

        <span class="token comment"># generate messages</span>
        msgs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'coro_{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># create tasks</span>
        fs <span class="token operator">=</span> <span class="token punctuation">[</span>loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>handler<span class="token punctuation">(</span>pool<span class="token punctuation">,</span> _m<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _m <span class="token keyword">in</span> msgs<span class="token punctuation">]</span>

        <span class="token comment"># wait all tasks done</span>
        done<span class="token punctuation">,</span> pending <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>fs<span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> done<span class="token punctuation">:</span> <span class="token keyword">print</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
host <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span>
port <span class="token operator">=</span> <span class="token number">9527</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>main<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ ncat -l <span class="token number">9527</span> --keep-open --exec <span class="token string">"/bin/cat"</span> <span class="token operator">&amp;</span>
$ python3 conn_pool.py
echo: b<span class="token string">'coro_1'</span>
echo: b<span class="token string">'coro_0'</span>
echo: b<span class="token string">'coro_2'</span>
echo: b<span class="token string">'coro_3'</span>
echo: b<span class="token string">'coro_4'</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Get domain name</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">import</span> asyncio
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">await</span> loop<span class="token punctuation">.</span>getaddrinfo<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">>></span><span class="token operator">></span> addrs <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>getaddrinfo<span class="token punctuation">(</span><span class="token string">'github.com'</span><span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> a <span class="token keyword">in</span> addrs<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     family<span class="token punctuation">,</span> typ<span class="token punctuation">,</span> proto<span class="token punctuation">,</span> name<span class="token punctuation">,</span> sockaddr <span class="token operator">=</span> a
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>     <span class="token keyword">print</span><span class="token punctuation">(</span>sockaddr<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">(</span><span class="token string">'192.30.253.113'</span><span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'192.30.253.113'</span><span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'192.30.253.112'</span><span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token string">'192.30.253.112'</span><span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Gather Results</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> ssl


path <span class="token operator">=</span> ssl<span class="token punctuation">.</span>get_default_verify_paths<span class="token punctuation">(</span><span class="token punctuation">)</span>
sslctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span><span class="token punctuation">)</span>
sslctx<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_REQUIRED
sslctx<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">True</span>
sslctx<span class="token punctuation">.</span>load_verify_locations<span class="token punctuation">(</span>path<span class="token punctuation">.</span>cafile<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    r<span class="token punctuation">,</span> w <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>open_connection<span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> ssl<span class="token operator">=</span>sslctx<span class="token punctuation">)</span>
    req <span class="token operator">=</span> <span class="token string">"GET / HTTP/1.1\r\n"</span>
    req <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"Host: </span><span class="token interpolation"><span class="token punctuation">{</span>host<span class="token punctuation">}</span></span><span class="token string">\r\n"</span></span>
    req <span class="token operator">+=</span> <span class="token string">"Connection: close\r\n"</span>
    req <span class="token operator">+=</span> <span class="token string">"\r\n"</span>

    <span class="token comment"># send request</span>
    w<span class="token punctuation">.</span>write<span class="token punctuation">(</span>req<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># recv response</span>
    resp <span class="token operator">=</span> <span class="token string">""</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        line <span class="token operator">=</span> <span class="token keyword">await</span> r<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        line <span class="token operator">=</span> line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
        resp <span class="token operator">+=</span> line

    <span class="token comment"># close writer</span>
    w<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> w<span class="token punctuation">.</span>wait_closed<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    url <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"python.org"</span><span class="token punctuation">,</span> <span class="token string">"github.com"</span><span class="token punctuation">,</span> <span class="token string">"google.com"</span><span class="token punctuation">]</span>
    fut <span class="token operator">=</span> <span class="token punctuation">[</span>fetch<span class="token punctuation">(</span>u<span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">)</span> <span class="token keyword">for</span> u <span class="token keyword">in</span> url<span class="token punctuation">]</span>
    resps <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>fut<span class="token punctuation">)</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> resps<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python fetch.py
HTTP/1.1 <span class="token number">301</span> Moved Permanently
HTTP/1.1 <span class="token number">200</span> OK
HTTP/1.1 <span class="token number">301</span> Moved Permanently</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple asyncio UDP echo server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> socket

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">3553</span>

sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> n_bytes<span class="token punctuation">,</span> fut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> registed<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fd <span class="token operator">=</span> sock<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> fut <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        fut <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> registed<span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>remove_reader<span class="token punctuation">(</span>fd<span class="token punctuation">)</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> addr <span class="token operator">=</span> sock<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span>n_bytes<span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>BlockingIOError<span class="token punctuation">,</span> InterruptedError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>add_reader<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> recvfrom<span class="token punctuation">,</span> loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> n_bytes<span class="token punctuation">,</span> fut<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        fut<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> fut

<span class="token keyword">def</span> <span class="token function">sendto</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> data<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> fut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> registed<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    fd <span class="token operator">=</span> sock<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> fut <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        fut <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> registed<span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>remove_writer<span class="token punctuation">(</span>fd<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        n <span class="token operator">=</span> sock<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
    <span class="token keyword">except</span> <span class="token punctuation">(</span>BlockingIOError<span class="token punctuation">,</span> InterruptedError<span class="token punctuation">)</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>add_writer<span class="token punctuation">(</span>fd<span class="token punctuation">,</span> sendto<span class="token punctuation">,</span> loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> data<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> fut<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        fut<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">return</span> fut

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">udp_server</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sock<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        data<span class="token punctuation">,</span> addr <span class="token operator">=</span> <span class="token keyword">await</span> recvfrom<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        n_bytes <span class="token operator">=</span> <span class="token keyword">await</span> sendto<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> data<span class="token punctuation">,</span> addr<span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>udp_server<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sock<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 udp_server.py
$ <span class="token function">nc</span> -u localhost <span class="token number">3553</span>
Hello UDP
Hello UDP</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple asyncio Web server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> socket

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">9527</span>
s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">make_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    header  <span class="token operator">=</span> <span class="token string">b"HTTP/1.1 200 OK\r\n"</span>
    header <span class="token operator">+=</span> <span class="token string">b"Content-Type: text/html\r\n"</span>
    header <span class="token operator">+=</span> <span class="token string">b"\r\n"</span>
    <span class="token keyword">return</span> header

<span class="token keyword">def</span> <span class="token function">make_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    resp  <span class="token operator">=</span> <span class="token string">b'&lt;html>'</span>
    resp <span class="token operator">+=</span> <span class="token string">b'&lt;body>&lt;h3>Hello World&lt;/h3>&lt;/body>'</span>
    resp <span class="token operator">+=</span> <span class="token string">b'&lt;/html>'</span>
    <span class="token keyword">return</span> resp

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    req <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_recv<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> req<span class="token punctuation">:</span>
        resp <span class="token operator">=</span> make_header<span class="token punctuation">(</span><span class="token punctuation">)</span>
        resp <span class="token operator">+=</span> make_body<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_sendall<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> resp<span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> loop<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_accept<span class="token punctuation">(</span>sock<span class="token punctuation">)</span>
        loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>handler<span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>server<span class="token punctuation">(</span>s<span class="token punctuation">,</span> loop<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># Then open browser with url: localhost:9527</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple HTTPS Web Server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> ssl

ctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_TLS_SERVER<span class="token punctuation">)</span>
ctx<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span><span class="token string">'crt.pem'</span><span class="token punctuation">,</span> <span class="token string">'key.pem'</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">conn</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    _ <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    head <span class="token operator">=</span> <span class="token string">b"HTTP/1.1 200 OK\r\n"</span>
    head <span class="token operator">+=</span> <span class="token string">b"Content-Type: text/html\r\n"</span>
    head <span class="token operator">+=</span> <span class="token string">b"\r\n"</span>

    body <span class="token operator">=</span> <span class="token string">b"&lt;!doctype html>"</span>
    body <span class="token operator">+=</span> <span class="token string">b"&lt;html>"</span>
    body <span class="token operator">+=</span> <span class="token string">b"&lt;body>&lt;h1>Awesome Python&lt;/h1>&lt;/body>"</span>
    body <span class="token operator">+=</span> <span class="token string">b"&lt;/html>"</span>

    writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>head <span class="token operator">+</span> body<span class="token punctuation">)</span>
    writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    srv <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>start_server<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> ssl<span class="token operator">=</span>ctx<span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> srv<span class="token punctuation">:</span>
        <span class="token keyword">await</span> srv<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple HTTPS Web server (low-level api)</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> ssl

<span class="token keyword">def</span> <span class="token function">make_header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    head  <span class="token operator">=</span> <span class="token string">b'HTTP/1.1 200 OK\r\n'</span>
    head <span class="token operator">+=</span> <span class="token string">b'Content-type: text/html\r\n'</span>
    head <span class="token operator">+=</span> <span class="token string">b'\r\n'</span>
    <span class="token keyword">return</span> head

<span class="token keyword">def</span> <span class="token function">make_body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    resp  <span class="token operator">=</span> <span class="token string">b'&lt;html>'</span>
    resp <span class="token operator">+=</span> <span class="token string">b'&lt;h1>Hello SSL&lt;/h1>'</span>
    resp <span class="token operator">+=</span> <span class="token string">b'&lt;/html>'</span>
    <span class="token keyword">return</span> resp

sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'localhost'</span> <span class="token punctuation">,</span> <span class="token number">4433</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

sslctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span>ssl<span class="token punctuation">.</span>PROTOCOL_SSLv23<span class="token punctuation">)</span>
sslctx<span class="token punctuation">.</span>load_cert_chain<span class="token punctuation">(</span>certfile<span class="token operator">=</span><span class="token string">'./root-ca.crt'</span><span class="token punctuation">,</span>
                       keyfile<span class="token operator">=</span><span class="token string">'./root-ca.key'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">do_handshake</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sock_fd <span class="token operator">=</span> sock<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        sock<span class="token punctuation">.</span>do_handshake<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ssl<span class="token punctuation">.</span>SSLWantReadError<span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>remove_reader<span class="token punctuation">(</span>sock_fd<span class="token punctuation">)</span>
        loop<span class="token punctuation">.</span>add_reader<span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> do_handshake<span class="token punctuation">,</span>
                        loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token keyword">except</span> ssl<span class="token punctuation">.</span>SSLWantWriteError<span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>remove_writer<span class="token punctuation">(</span>sock_fd<span class="token punctuation">)</span>
        loop<span class="token punctuation">.</span>add_writer<span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> do_handshake<span class="token punctuation">,</span>
                        loop<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    loop<span class="token punctuation">.</span>remove_reader<span class="token punctuation">(</span>sock_fd<span class="token punctuation">)</span>
    loop<span class="token punctuation">.</span>remove_writer<span class="token punctuation">(</span>sock_fd<span class="token punctuation">)</span>
    waiter<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">handle_read</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        req <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> ssl<span class="token punctuation">.</span>SSLWantReadError<span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>remove_reader<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        loop<span class="token punctuation">.</span>add_reader<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handle_read<span class="token punctuation">,</span>
                        loop<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    loop<span class="token punctuation">.</span>remove_reader<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    waiter<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span>req<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">handle_write</span><span class="token punctuation">(</span>loop<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        resp <span class="token operator">=</span> make_header<span class="token punctuation">(</span><span class="token punctuation">)</span>
        resp <span class="token operator">+=</span> make_body<span class="token punctuation">(</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>resp<span class="token punctuation">)</span>
    <span class="token keyword">except</span> ssl<span class="token punctuation">.</span>SSLWantReadError<span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>remove_writer<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        loop<span class="token punctuation">.</span>add_writer<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handle_write<span class="token punctuation">,</span>
                        loop<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    loop<span class="token punctuation">.</span>remove_writer<span class="token punctuation">(</span>conn<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
    waiter<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">server</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_accept<span class="token punctuation">(</span>sock<span class="token punctuation">)</span>
        conn<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        sslconn <span class="token operator">=</span> sslctx<span class="token punctuation">.</span>wrap_socket<span class="token punctuation">(</span>conn<span class="token punctuation">,</span>
                                     server_side<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                                     do_handshake_on_connect<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token comment"># wait SSL handshake</span>
        waiter <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>
        do_handshake<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sslconn<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span>
        <span class="token keyword">await</span> waiter

        <span class="token comment"># wait read request</span>
        waiter <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>
        handle_read<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sslconn<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span>
        msg <span class="token operator">=</span> <span class="token keyword">await</span> waiter

        <span class="token comment"># wait write response</span>
        waiter <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>
        handle_write<span class="token punctuation">(</span>loop<span class="token punctuation">,</span> sslconn<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> waiter<span class="token punctuation">)</span>
        <span class="token keyword">await</span> waiter

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>server<span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash"><span class="token comment"># console 1</span>

$ openssl genrsa -out root-ca.key <span class="token number">2048</span>
$ openssl req -x509 -new -nodes -key root-ca.key -days <span class="token number">365</span> -out root-ca.crt
$ python3 Simple_https_server.py

<span class="token comment"># console 2</span>

$ <span class="token function">curl</span> https://localhost:4433 -v          <span class="token punctuation">\</span>
<span class="token operator">></span>      --resolve localhost:4433:127.0.0.1 <span class="token punctuation">\</span>
<span class="token operator">></span>      --cacert ~/test/root-ca.crt</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>TLS Upgrade</h2>
<p><strong>New in Python 3.7</strong></p>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> ssl


<span class="token keyword">class</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>Protocol<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> on_con_lost<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>on_con_lost <span class="token operator">=</span> on_con_lost
        self<span class="token punctuation">.</span>resp <span class="token operator">=</span> <span class="token string">b""</span>

    <span class="token keyword">def</span> <span class="token function">data_received</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>resp <span class="token operator">+=</span> data

    <span class="token keyword">def</span> <span class="token function">connection_lost</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc<span class="token punctuation">)</span><span class="token punctuation">:</span>
        resp <span class="token operator">=</span> self<span class="token punctuation">.</span>resp<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>on_con_lost<span class="token punctuation">.</span>set_result<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    paths <span class="token operator">=</span> ssl<span class="token punctuation">.</span>get_default_verify_paths<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sslctx <span class="token operator">=</span> ssl<span class="token punctuation">.</span>SSLContext<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sslctx<span class="token punctuation">.</span>verify_mode <span class="token operator">=</span> ssl<span class="token punctuation">.</span>CERT_REQUIRED
    sslctx<span class="token punctuation">.</span>check_hostname <span class="token operator">=</span> <span class="token boolean">True</span>
    sslctx<span class="token punctuation">.</span>load_verify_locations<span class="token punctuation">(</span>paths<span class="token punctuation">.</span>cafile<span class="token punctuation">)</span>

    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_running_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    on_con_lost <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_future<span class="token punctuation">(</span><span class="token punctuation">)</span>

    tr<span class="token punctuation">,</span> proto <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>create_connection<span class="token punctuation">(</span>
        <span class="token keyword">lambda</span><span class="token punctuation">:</span> HttpClient<span class="token punctuation">(</span>on_con_lost<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"github.com"</span><span class="token punctuation">,</span> <span class="token number">443</span>
    <span class="token punctuation">)</span>
    new_tr <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>start_tls<span class="token punctuation">(</span>tr<span class="token punctuation">,</span> proto<span class="token punctuation">,</span> sslctx<span class="token punctuation">)</span>
    req <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"GET / HTTP/1.1\r\n"</span></span>
    req <span class="token operator">+=</span> <span class="token string">"Host: github.com\r\n"</span>
    req <span class="token operator">+=</span> <span class="token string">"Connection: close\r\n"</span>
    req <span class="token operator">+=</span> <span class="token string">"\r\n"</span>
    new_tr<span class="token punctuation">.</span>write<span class="token punctuation">(</span>req<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">await</span> on_con_lost
    new_tr<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ python3 --version
Python <span class="token number">3.7</span>.0
$ python3 https.py
HTTP/1.1 <span class="token number">200</span> OK</code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Using sendfile</h2>
<p><strong>New in Python 3.7</strong></p>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token keyword">import</span> asyncio

path <span class="token operator">=</span> <span class="token string">"index.html"</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">conn</span><span class="token punctuation">(</span>reader<span class="token punctuation">,</span> writer<span class="token punctuation">)</span><span class="token punctuation">:</span>

    loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    _ <span class="token operator">=</span> <span class="token keyword">await</span> reader<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>

    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        tr <span class="token operator">=</span> writer<span class="token punctuation">.</span>transport
        head <span class="token operator">=</span> <span class="token string">b"HTTP/1.1 200 OK\r\n"</span>
        head <span class="token operator">+=</span> <span class="token string">b"Content-Type: text/html\r\n"</span>
        head <span class="token operator">+=</span> <span class="token string">b"\r\n"</span>

        tr<span class="token punctuation">.</span>write<span class="token punctuation">(</span>head<span class="token punctuation">)</span>
        <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sendfile<span class="token punctuation">(</span>tr<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># run a simplle http server</span>
    srv <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>start_server<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> srv<span class="token punctuation">:</span>
        <span class="token keyword">await</span> srv<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>

asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>output:</p>
<div class="gatsby-highlight" data-language="bash"><pre style="counter-reset: linenumber NaN" class="language-bash line-numbers"><code class="language-bash">$ <span class="token builtin class-name">echo</span> <span class="token string">'&lt;!doctype html>&lt;h1>Awesome Python&lt;/h1>'</span> <span class="token operator">></span> index.html
$ python http.py <span class="token operator">&amp;</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token number">60506</span>
$ <span class="token function">curl</span> http://localhost:8000
<span class="token operator">&lt;</span><span class="token operator">!</span>doctype html<span class="token operator">></span><span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>></span>Awesome Python<span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>></span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<h2>Simple asyncio WSGI web server</h2>
<div class="gatsby-highlight" data-language="python"><pre style="counter-reset: linenumber NaN" class="language-python line-numbers"><code class="language-python"><span class="token comment"># ref: PEP333</span>

<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> socket
<span class="token keyword">import</span> io
<span class="token keyword">import</span> sys

<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> Response

host <span class="token operator">=</span> <span class="token string">'localhost'</span>
port <span class="token operator">=</span> <span class="token number">9527</span>
s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>setblocking<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

loop <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">WSGIServer</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_sock <span class="token operator">=</span> sock
        self<span class="token punctuation">.</span>_app <span class="token operator">=</span> app
        self<span class="token punctuation">.</span>_header <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">""" HTTP Request Format:

        GET /hello.htm HTTP/1.1\r\n
        Accept-Language: en-us\r\n
        ...
        Connection: Keep-Alive\r\n
        """</span>
        <span class="token comment"># bytes to string</span>
        req_info <span class="token operator">=</span> req<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
        first_line <span class="token operator">=</span> req_info<span class="token punctuation">.</span>splitlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> ver <span class="token operator">=</span> first_line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> ver

    <span class="token keyword">def</span> <span class="token function">get_environ</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> req<span class="token punctuation">,</span> method<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment"># Required WSGI variables</span>
        env<span class="token punctuation">[</span><span class="token string">'wsgi.version'</span><span class="token punctuation">]</span>      <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        env<span class="token punctuation">[</span><span class="token string">'wsgi.url_scheme'</span><span class="token punctuation">]</span>   <span class="token operator">=</span> <span class="token string">'http'</span>
        env<span class="token punctuation">[</span><span class="token string">'wsgi.input'</span><span class="token punctuation">]</span>        <span class="token operator">=</span> req
        env<span class="token punctuation">[</span><span class="token string">'wsgi.errors'</span><span class="token punctuation">]</span>       <span class="token operator">=</span> sys<span class="token punctuation">.</span>stderr
        env<span class="token punctuation">[</span><span class="token string">'wsgi.multithread'</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token boolean">False</span>
        env<span class="token punctuation">[</span><span class="token string">'wsgi.multiprocess'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
        env<span class="token punctuation">[</span><span class="token string">'wsgi.run_once'</span><span class="token punctuation">]</span>     <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token comment"># Required CGI variables</span>
        env<span class="token punctuation">[</span><span class="token string">'REQUEST_METHOD'</span><span class="token punctuation">]</span>    <span class="token operator">=</span> method    <span class="token comment"># GET</span>
        env<span class="token punctuation">[</span><span class="token string">'PATH_INFO'</span><span class="token punctuation">]</span>         <span class="token operator">=</span> path      <span class="token comment"># /hello</span>
        env<span class="token punctuation">[</span><span class="token string">'SERVER_NAME'</span><span class="token punctuation">]</span>       <span class="token operator">=</span> host      <span class="token comment"># localhost</span>
        env<span class="token punctuation">[</span><span class="token string">'SERVER_PORT'</span><span class="token punctuation">]</span>       <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span> <span class="token comment"># 9527</span>
        <span class="token keyword">return</span> env

    <span class="token keyword">def</span> <span class="token function">start_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> status<span class="token punctuation">,</span> resp_header<span class="token punctuation">,</span> exc_info<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        header <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'Server'</span><span class="token punctuation">,</span> <span class="token string">'WSGIServer 0.2'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>headers_set <span class="token operator">=</span> <span class="token punctuation">[</span>status<span class="token punctuation">,</span> resp_header <span class="token operator">+</span> header<span class="token punctuation">]</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">finish_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conn<span class="token punctuation">,</span> data<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">:</span>
        status<span class="token punctuation">,</span> resp_header <span class="token operator">=</span> headers

        <span class="token comment"># make header</span>
        resp <span class="token operator">=</span> <span class="token string">'HTTP/1.1 {0}\r\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span>
        <span class="token keyword">for</span> header <span class="token keyword">in</span> resp_header<span class="token punctuation">:</span>
            resp <span class="token operator">+=</span> <span class="token string">'{0}: {1}\r\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">*</span>header<span class="token punctuation">)</span>
        resp <span class="token operator">+=</span> <span class="token string">'\r\n'</span>

        <span class="token comment"># make body</span>
        resp <span class="token operator">+=</span> <span class="token string">'{0}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_sendall<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span>resp<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run_server</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_accept<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_sock<span class="token punctuation">)</span>
            loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>handle_request<span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> conn<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># get request data</span>
        req <span class="token operator">=</span> <span class="token keyword">await</span> loop<span class="token punctuation">.</span>sock_recv<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> req<span class="token punctuation">:</span>
            method<span class="token punctuation">,</span> path<span class="token punctuation">,</span> ver <span class="token operator">=</span> self<span class="token punctuation">.</span>parse_request<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
            <span class="token comment"># get environment</span>
            env <span class="token operator">=</span> self<span class="token punctuation">.</span>get_environ<span class="token punctuation">(</span>req<span class="token punctuation">,</span> method<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
            <span class="token comment"># get application execute result</span>
            res <span class="token operator">=</span> self<span class="token punctuation">.</span>_app<span class="token punctuation">(</span>env<span class="token punctuation">,</span> self<span class="token punctuation">.</span>start_response<span class="token punctuation">)</span>
            res <span class="token operator">=</span> <span class="token punctuation">[</span>_<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">]</span>
            res <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>
                 self<span class="token punctuation">.</span>finish_response<span class="token punctuation">(</span>conn<span class="token punctuation">,</span> res<span class="token punctuation">,</span> self<span class="token punctuation">.</span>headers_set<span class="token punctuation">)</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/hello'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token string">"Hello WSGI"</span><span class="token punctuation">,</span>mimetype<span class="token operator">=</span><span class="token string">"text/plain"</span><span class="token punctuation">)</span>

server <span class="token operator">=</span> WSGIServer<span class="token punctuation">(</span>s<span class="token punctuation">,</span> app<span class="token punctuation">.</span>wsgi_app<span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>server<span class="token punctuation">.</span>run_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Then open browser with url: localhost:9527/hello</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p><a href="https://www.pythonsheets.com/">Acesse a Referência original 1:</a>
<a href="https://www.pythoncheatsheet.org/">Acesse a Referência original 2:</a></p></section><hr style="margin-bottom:1.75rem"/><footer><div style="display:flex;margin-bottom:4.375rem"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:50px;height:50px;margin-right:0.875rem;margin-bottom:0;min-width:50px;border-radius:100%"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAACXBIWXMAAAsSAAALEgHS3X78AAACwUlEQVQ4y42UWU8UQRDHefFjGL+Arz6aKIlHMOFNXiSBqFEw0ZiIbtCAIYTIIYeGQ1dwOeKycigQD1DX5QwJEoSNirLdPdPbMz3dM73LqfFNaxjDrhiBpDLpY37dVf+q6gxKyM6mx4i2af9uZeyEIWKa2FlB9jKCr2FgHe8NBtISeH6UhnxWoFB2+0R0knKBYX1HGLuucguHHxt3j6mX98yxIBuq5jAeDzLOU/x2GGIj3wiL4+iUXpWpYlEtsY6cZaTW0OcZvTpTLc5qjBHP/xQMc8DgYIMRiLC/zBqo4M4qwova3FtKNaLWUc8ta6iGS4X1WBoMJFhyA828iFcdSUTaje4b1vuAYUn3rECBbDsvl3+ikWYz5BN2AmkpGJO45k4GK83qoyroE71l1mgn67oqkt8R/kqEg1vPyoE7PFhkjTQbMPXCzvCuNQziz7P9efLTtP4xTOtPKRjUgELdDKKN6/ADrjycqDup4hr27nNhLyVTfaz1nNz4FYNoQef+Mg5SQ7T1WarrioCBWkXPynlfqQXibRWMC4MbIy1mQ7YKB9jzCt5bakFVRNrZu0eGwfDTYqvljC0TaLTT6LwshIP0FIwJo+TLB32wivfctK4dWJnqZYEC0Zxjh9sM2IVU+fPlRIhND7D2QilV2s1e9YKqkz2s8bTzutF802KCvCAVhKNtbkU6WG8Jf3Xf7LvNZeJvGCbgecclWXIwGbgoyw8lF8YpKESWiAdDYYHDTTmOt75V4X/yDKnSlsjsMJ0L09rjCtQCxost+QMBeX3/CpSHsHF6e6WKBPIBANQGpHq4yRQKw4qGSKjYurBvLVgkIAvpXbG9POHUphy7Idvx59sPc+0HuXZdlqo9ocaeMCDhIPrfloTLqcvPR+jCGI1O6NFxHdoAZIOuhrLf5TFwldCIaeAtY3G3sbe9AXt6SXa133dG1a0ljAUNAAAAAElFTkSuQmCC" alt="Reativa" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms;border-radius:50%"/><noscript><picture><source srcset="/static/d2742f2dddd737dec60ee2a5226edb06/000d3/icon.png 1x,
/static/d2742f2dddd737dec60ee2a5226edb06/bc2a0/icon.png 1.5x,
/static/d2742f2dddd737dec60ee2a5226edb06/89cf4/icon.png 2x" /><img loading="lazy" width="50" height="50" srcset="/static/d2742f2dddd737dec60ee2a5226edb06/000d3/icon.png 1x,
/static/d2742f2dddd737dec60ee2a5226edb06/bc2a0/icon.png 1.5x,
/static/d2742f2dddd737dec60ee2a5226edb06/89cf4/icon.png 2x" src="/static/d2742f2dddd737dec60ee2a5226edb06/000d3/icon.png" alt="Reativa" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><p><strong>Está curtindo os conteúdos da Reativa? Quer que a gente te ajude a ser um dev melhor?<!-- --> </strong> <!-- --> <a href="http://bit.ly/form-reativa" target="_blank" rel="noopener noreferrer">Deixe seu melhor email aqui.</a> </p></div></footer></article><nav><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"><li><a rel="prev" href="/python-basic/">← <!-- -->Python para iniciantes</a></li><li><a rel="next" href="/python-sqlalchemy/">Python tudo sobre SQLAlchemy<!-- --> →</a></li></ul></nav></main><footer>© <!-- -->2020<!-- -->, Sua melhor escolha para aprender programação:<!-- --> <a href="https://reativa.dev">Reativa Tecnologia</a></footer></div></div></div><script>
  
  
  if(true) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-155080700-5', 'auto', {});
      
      
      
      
      
      }</script><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/python-asyncio/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-da4c9f678cc075cd8c26.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-2642abeb110b544c12ef.js"],"component---src-pages-404-js":["/component---src-pages-404-js-ba8fab707f547b8d2140.js"],"component---src-pages-index-js":["/component---src-pages-index-js-511e09b2f0f1386b8494.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-2642abeb110b544c12ef.js" async=""></script><script src="/commons-2011af21236d35f89581.js" async=""></script><script src="/app-da4c9f678cc075cd8c26.js" async=""></script><script src="/netlify-identity-widget-71f3202b04975b5e224a.js" async=""></script><script src="/styles-989bb08664f2608f37ec.js" async=""></script><script src="/webpack-runtime-002569f02672c1c38772.js" async=""></script></body></html>